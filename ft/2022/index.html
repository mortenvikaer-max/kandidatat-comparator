<!doctype html>
<html lang="da">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Valgbar – Folketingsvalg 2022</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

  <style>
    :root{ --vb-navy:#234a5a; --vb-navy-2:#1b3d4d; }
    .vb-card{ background:#fff; border:1px solid #e5e7eb; border-radius:16px; box-shadow:0 1px 2px rgba(16,24,40,.04); }
    .vb-btn{ display:inline-flex; align-items:center; gap:.5rem; padding:.5rem .75rem; border:1px solid #e5e7eb; border-radius:12px; background:#fff; }
    .vb-btn:disabled{ opacity:.5; cursor:not-allowed; }
    .vb-tabbox{ flex:1 1 auto; border:1px solid #e5e7eb; border-radius:12px; padding:.6rem 1rem; text-align:center; cursor:pointer; user-select:none; background:#fff; }
    .vb-tabbox.active{ background:#111827; color:#fff; border-color:#111827; }
    .vb-combo-btn{ width:100%; border:1px solid #e5e7eb; border-radius:12px; padding:.5rem .75rem; background:#fff;
                   display:flex; align-items:center; justify-content:space-between; }
    .vb-combo-btn[disabled]{ opacity:.6; cursor:not-allowed; }
    .vb-combo-label{ display:flex; align-items:center; gap:.75rem; min-width:0; }
    .vb-badge{ height:28px; width:28px; display:inline-flex; align-items:center; justify-content:center;
               border-radius:9999px; border:1px solid transparent; font-weight:600; font-size:.9rem; }
    .vb-menu{ position:absolute; z-index:50; margin-top:.25rem; width:100%;
              max-height:18rem; overflow:auto; background:#fff; border:1px solid #e5e7eb;
              border-radius:12px; box-shadow:0 8px 24px rgba(0,0,0,.08); }
    .vb-option{ display:flex; align-items:center; gap:.75rem; padding:.5rem .75rem; cursor:pointer; }
    .vb-option:hover, .vb-option[aria-selected="true"]{ background:#f3f4f6; }
    .table-sticky thead th:first-child, .table-sticky tbody td:first-child, .table-sticky tfoot th:first-child{ position:sticky; left:0; background:#fff; }
    .vb-hero{ background:linear-gradient(180deg, var(--vb-navy) 0%, var(--vb-navy-2) 100%); color:#fff; }

    /* Chips til multivælger */
    .vb-chip{ display:inline-flex; align-items:center; gap:.5rem; padding:.35rem .6rem; border:1px solid #e5e7eb; border-radius:9999px; background:#fff; font-size:.9rem; }
    .vb-chip.active{ background:#111827; color:#fff; border-color:#111827; }
  </style>
</head>

<body class="bg-gray-50 text-gray-900">

<header class="vb-hero">
  <div class="mx-auto max-w-6xl px-4 py-6 flex items-center gap-4">
    <a href="../../" class="flex items-center gap-3">
      <img src="../../Valgbar-transparent3.png" alt="Valgbar" class="h-32 w-auto" />
    </a>
  </div>

  <div class="mx-auto max-w-6xl px-4 pb-8">
    <div class="text-white/80 text-base md:text-lg">
      Vælg først en <strong>storkreds</strong> og derefter en <strong>kreds</strong> for at se partier og kandidater.
      Du kan nu <strong>tilføje flere kredse</strong> i samme storkreds med chipsene nedenfor.
    </div>

    <div class="mt-6 grid grid-cols-1 md:grid-cols-3 gap-3">
      <div>
        <label class="text-sm text-white/80">Storkreds</label>
        <select id="storkredsSelect" class="w-full mt-1 rounded-xl border p-2 text-gray-900"></select>
      </div>
      <div class="md:col-span-2">
        <label class="text-sm text-white/80">Kreds</label>
        <select id="kredsSelect" class="w-full mt-1 rounded-xl border p-2 text-gray-900" disabled></select>
        <div id="kredsMulti" class="mt-2 flex flex-wrap gap-2 hidden"></div>
      </div>
    </div>

    <div id="error" class="mt-3 text-sm text-red-200"></div>
  </div>
</header>

<main class="mx-auto max-w-6xl p-4 space-y-6">
  <section>
    <div class="flex items-center justify-between mb-3">
      <h2 class="text-xl font-semibold">Partier og kandidater</h2>
      <div id="storkredstitel" class="text-gray-500"></div>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
      <aside class="md:col-span-1 vb-card p-4 space-y-2">
        <label class="text-sm font-medium">Vælg parti</label>
        <div id="partyCombo" class="relative">
          <button id="partyButton" type="button" class="vb-combo-btn" aria-haspopup="listbox" aria-expanded="false" disabled>
            <span id="partyButtonContent" class="vb-combo-label">
              <span class="vb-badge" style="background:#e5e7eb; color:#111827; border-color:#e5e7eb"> </span>
              <span class="truncate text-gray-500">Vælg kreds først…</span>
            </span>
            <svg class="h-4 w-4 opacity-60" viewBox="0 0 20 20" fill="currentColor"><path d="M5.23 7.21a.75.75 0 011.06.02L10 11.104l3.71-3.873a.75.75 0 011.08 1.04l-4.24 4.43a.75.75 0 01-1.08 0l-4.24-4.43a.75.75 0 01.02-1.06z"/></svg>
          </button>
          <div id="partyMenu" class="vb-menu hidden" role="listbox" tabindex="-1" aria-labelledby="partyButton"></div>
        </div>
      </aside>

      <section class="md:col-span-2 vb-card p-4 space-y-3" id="partyDetail">
        <div id="partyDetailHeader" class="text-gray-500 text-sm">Vælg et parti i drop-down menuen.</div>
        <div id="candidateList" class="grid grid-cols-1 md:grid-cols-2 gap-2"></div>
      </section>
    </div>
  </section>

  <section id="compareSection" class="vb-card p-4 space-y-3 hidden">
    <div class="flex items-center justify-between">
      <h2 class="font-medium">Sammenligning af kandidater</h2>
      <button id="btnClearAll" class="vb-btn">Nulstil alle valgte kandidater</button>
    </div>
    <div id="selectedList" class="space-y-2"></div>
  </section>

  <section id="tabsCard" class="vb-card p-4 space-y-4 hidden">
    <!-- Kredstotaler (ny) -->
    <div id="kredsTotalsWrap" class="hidden">
      <h3 class="font-medium">Kredstotaler</h3>
      <div class="overflow-auto">
        <table class="w-full text-sm min-w-[640px]" id="kredsTotalsTable">
          <thead id="kredsTotalsThead"></thead>
          <tbody id="kredsTotalsTbody"></tbody>
        </table>
      </div>
      <hr class="my-2"/>
    </div>

    <div class="rounded-2xl border bg-white p-2 shadow-sm flex gap-2">
      <button class="vb-tabbox active" data-tab="valgsted-tabel">Tabel pr. valgsted</button>
      <button class="vb-tabbox" data-tab="valgsted-diagram">Diagram pr. valgsted</button>
    </div>

    <div id="tab-valgsted-tabel">
      <div class="overflow-auto">
        <table class="table-sticky w-full text-sm min-w-[720px]" id="psTable">
          <thead id="psThead"></thead>
          <tbody id="psTbody"></tbody>
          <tfoot id="psTFoot"></tfoot>
        </table>
      </div>
    </div>

    <div id="tab-valgsted-diagram" class="hidden">
      <div style="height: 420px"><canvas id="chart"></canvas></div>
    </div>
  </section>
</main>

<script>
/* ====== DATA-STI (FT 2022) ====== */
const BASE_PATH = '../../data/ft/2022/';

/* Storkredse */
const STORKREDSE = [
  "Bornholms Storkreds",
  "Fyns Storkreds",
  "Københavns Omegns Storkreds",
  "Københavns Storkreds",
  "Nordjyllands Storkreds",
  "Nordsjællands Storkreds",
  "Sjællands Storkreds",
  "Sydjyllands Storkreds",
  "Vestjyllands Storkreds",
  "Østjyllands Storkreds"
];

/* Kredse – udfyldt for Bornholm + Københavns Storkreds */
const KREDS_BY_STORKREDS = {
  "Bornholms Storkreds": ["Rønnekredsen","Aakirkebykredsen"],
  "Københavns Storkreds": [
    "Bispebjergkredsen",
    "Brønshøjkredsen",
    "Falkonerkredsen",
    "Indre_Bykredsen",
    "Nørrebrokredsen",
    "Slotskredsen",
    "Sundbyvesterkredsen",
    "Sundbyøsterkredsen",
    "Tårnbykredsen",
    "Valbykredsen",
    "Vesterbrokredsen",
    "Østerbrokredsen"
  ],
  "Fyns Storkreds": [],
  "Københavns Omegns Storkreds": [],
  "Nordjyllands Storkreds": [],
  "Nordsjællands Storkreds": [],
  "Sjællands Storkreds": [],
  "Sydjyllands Storkreds": [],
  "Vestjyllands Storkreds": [],
  "Østjyllands Storkreds": []
};

/* Farver/bogstaver */
const PARTY_COLORS = {"A":"#e03a3e","B":"#712082","C":"#2e7d32","D":"#0f766e","F":"#e5003d","I":"#00a0e3","O":"#0044aa","V":"#1b5eaa","Ø":"#c8102e","Å":"#3aaa35","Q":"#ff4fa3","K":"#ff9800","Æ":"#666666","M":"#6f42c1"};
const PARTY_LETTERS_BY_NAME = {
  "socialdemokratiet":"A",
  "radikale venstre":"B","det radikale venstre":"B",
  "konservative folkeparti":"C","det konservative folkeparti":"C",
  "nye borgerlige":"D",
  "sf":"F","socialistisk folkeparti":"F",
  "liberal alliance":"I",
  "venstre, danmarks liberale parti":"V","venstre":"V",
  "dansk folkeparti":"O",
  "enhedslisten":"Ø","enhedslisten - de rød-grønne":"Ø",
  "alternativet":"Å",
  "kristendemokraterne":"K","kd - kristendemokraterne":"K",
  "moderaterne":"M"
};
const DEFAULT_BADGE_BG="#e5e7eb", DEFAULT_BADGE_FG="#111827";

/* Helpers & state */
const state = {
  rows:[],
  storkreds:"",
  kreds:"",
  activeParty:"",
  selected:new Map(),
  chart:null,
  selectedKredse:new Set(), // NY
  cache:new Map()           // NY
};
const el = id => document.getElementById(id);
const fmt = n => new Intl.NumberFormat("da-DK").format(n);
const canon = s => (s||"").toString().trim();
const escapeHtml = s => (s||"").replace(/[&<>"]/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c]));
const isListestemmer = name => {
  const t = canon(name).toLowerCase();
  return t==="partiliste" || t==="listestemmer" || t==="liste";
};
const cleanPollingPlaceName = (name) => canon(name).replace(/^\s*\d+\.\s*/,'').trim();

const sortKandidaterAlpha = (a,b)=>{
  const al=isListestemmer(a.kandidat_navn), bl=isListestemmer(b.kandidat_navn);
  if(al&&!bl) return 1; if(!al&&bl) return -1;
  return a.kandidat_navn.localeCompare(b.kandidat_navn,"da");
};
function badge(letter){
  const bg=letter && PARTY_COLORS[letter] ? PARTY_COLORS[letter] : DEFAULT_BADGE_BG;
  const fg=letter && PARTY_COLORS[letter] ? "#fff" : DEFAULT_BADGE_FG;
  return { style:`background-color:${bg};color:${fg};border-color:${bg}`, text:(letter||" ") };
}

/* Init */
window.addEventListener("DOMContentLoaded", ()=>{
  initStorkredsDropdown(); initTabs();
  const p=new URLSearchParams(location.search), s=p.get("storkreds"), k=p.get("kreds");
  if(s && STORKREDSE.includes(s)){
    el("storkredsSelect").value=s; populateKredse(s);
    if(k && (KREDS_BY_STORKREDS[s]||[]).includes(k)){
      // Seed multivælg med startkreds
      state.selectedKredse = new Set([k]);
      renderKredsMulti(s);
      loadKredsSet(s, Array.from(state.selectedKredse));
    } else if(!(KREDS_BY_STORKREDS[s]||[]).length){
      // Storkreds uden kredsvalg -> load storkreds-data som før
      loadStorkredsData(s);
    }
  }
  el("btnClearAll")?.addEventListener('click', ()=>{ state.selected.clear(); renderAll(); });
  document.addEventListener('click',(e)=>{ const box=el('partyCombo'); if(box && !box.contains(e.target)) closePartyMenu(); });
  document.addEventListener('keydown',(e)=>{ if(e.key==='Escape') closePartyMenu(); });
});

/* Dropdowns */
function initStorkredsDropdown(){
  const ssel=el("storkredsSelect");
  ssel.innerHTML = `<option value="">Vælg storkreds…</option>` + STORKREDSE.map(s=>`<option value="${s}">${s}</option>`).join("");
  ssel.onchange = ()=>{
    const s=ssel.value; state.storkreds=s; state.kreds=""; state.activeParty=""; clearAll();
    state.selectedKredse.clear();
    if(s){
      const u=new URL(location.href); u.searchParams.set("storkreds",s); u.searchParams.delete("kreds"); history.replaceState({}, "", u);
      populateKredse(s);
      // Hvis storkreds har kredse, vis chips – ellers load storkredsdata
      const ks = KREDS_BY_STORKREDS[s] || [];
      if(ks.length){
        renderKredsMulti(s);
      }else{
        loadStorkredsData(s);
      }
    }
  };
  el("kredsSelect").disabled=true;
}

function populateKredse(storkreds){
  const ks = KREDS_BY_STORKREDS[storkreds] || [];
  const ksel = el("kredsSelect");
  renderKredsMulti(storkreds); // NY: tegn chips uanset hvad
  if(ks.length){
    ksel.disabled=false;
    ksel.innerHTML = `<option value="">Vælg kreds…</option>` + ks.map(k=>`<option value="${k}">${k}</option>`).join("");
    ksel.onchange = ()=>{
      const k=ksel.value; state.kreds=k; state.activeParty=""; state.selectedKredse.clear();
      clearAll(false); // bevar storkreds-titel-område, vi opdaterer lige efter
      if(k){
        state.selectedKredse.add(k);
        const u=new URL(location.href); u.searchParams.set("storkreds",storkreds); u.searchParams.set("kreds",k); history.replaceState({}, "", u);
        renderKredsMulti(storkreds);
        loadKredsSet(storkreds, Array.from(state.selectedKredse));
      }else{
        // Ingen kreds valgt endnu -> tom visning
        updateStorkredstitel();
      }
    };
  }else{
    ksel.disabled=true; ksel.innerHTML=`<option value="">(Ingen kredsvalg – viser hele storkredsen)</option>`;
    state.selectedKredse.clear();
    loadStorkredsData(storkreds);
  }
}

function renderKredsMulti(storkreds){
  const root = el("kredsMulti");
  const ks = KREDS_BY_STORKREDS[storkreds] || [];
  if(!ks.length){ root.classList.add("hidden"); root.innerHTML=""; return; }
  root.classList.remove("hidden");
  root.innerHTML = "";
  ks.forEach(k => {
    const active = state.selectedKredse.has(k);
    const btn = document.createElement("button");
    btn.className = `vb-chip ${active ? 'active' : ''}`;
    btn.innerHTML = `<span>${k.replaceAll('_',' ')}</span>${active?'<span aria-hidden="true">×</span>':''}`;
    btn.onclick = async ()=>{
      if(active) state.selectedKredse.delete(k); else state.selectedKredse.add(k);
      renderKredsMulti(storkreds);
      if(state.selectedKredse.size>0){
        await loadKredsSet(storkreds, Array.from(state.selectedKredse));
      }else{
        // Ingen kredse valgt -> ryd data, men behold UI
        state.rows=[]; state.activeParty=""; renderPartyCombobox(); renderAll(); updateStorkredstitel();
      }
    };
    root.appendChild(btn);
  });
}

/* UI clear */
function clearAll(resetTitle=true){
  state.rows=[]; state.selected.clear();
  const btn=el("partyButton"), btnc=el("partyButtonContent"); btn.disabled=true; btn.setAttribute('aria-expanded','false');
  btnc.innerHTML=`<span class="vb-badge" style="background:#e5e7eb;color:#111827;border-color:#e5e7eb"> </span><span class="truncate text-gray-500">Vælg kreds først…</span>`;
  el("partyMenu").innerHTML=""; el("partyDetailHeader").textContent="Vælg et parti i drop-down menuen.";
  el("candidateList").innerHTML="";
  if(resetTitle) el("storkredstitel").textContent="";
  renderAll();
}

/* Data-indlæsning – storkredsniveau (fallback som før) */
async function loadStorkredsData(storkreds){
  el("error").textContent=""; state.storkreds=storkreds; state.activeParty="";
  state.selectedKredse.clear();
  updateStorkredstitel();
  const s=encodeURIComponent(storkreds);
  const candidates=[ `${BASE_PATH}${s}_allepartier.csv`, `${BASE_PATH}${s}.csv` ];
  for(const url of candidates){
    try{
      const rows = await fetchCsvCached(url);
      state.rows = normalizeRows(rows, null);
      afterDataLoaded();
      return;
    }catch(e){}
  }
  el("error").textContent=`Kunne ikke finde data for ${storkreds}.`;
}

/* CSV-cache + normalisering */
async function fetchCsvCached(url){
  if(state.cache.has(url)) return state.cache.get(url);
  const r=await fetch(url,{cache:"no-store"}); if(!r.ok) throw new Error("404");
  const text=await r.text();
  const parsed=Papa.parse(text,{header:true,skipEmptyLines:true,transformHeader:h=>canon(h.toLowerCase())}).data;
  state.cache.set(url, parsed);
  return parsed;
}

function normalizeRows(rows, kredsName){
  return rows.map(r=>{
    let kandidatNavn = canon(r.kandidat_navn);
    const navnLower = kandidatNavn.toLowerCase();
    if (navnLower==="partiliste" || navnLower==="listestemmer" || navnLower==="liste") {
      kandidatNavn = "Partiliste";
    }
    const parti = canon(r.parti);
    const rawLetter = r.parti_bogstav || r.bogstav || r.parti_kode || r['parti (bogstav)'] || r.listebogstav;
    const L = canon(rawLetter).toUpperCase();
    const parti_letter = /^[A-ZÆØÅ]$/.test(L) ? L : "";
    const kandidat_id = `${parti.toLowerCase()}::${kandidatNavn.toLowerCase()}`;
    const kreds = kredsName || canon(r.kredsnavn || r.kreds || "");
    return {
      storkreds: canon(r.storkreds || r.kreds || r.kommune),
      kreds,
      valgsted_id: canon(r.valgsted_id || r.afstemningssted_id || r.sted_id || `${cleanPollingPlaceName(r.valgsted_navn||r.afstemningssted||r.sted_navn)}`),
      valgsted_navn: cleanPollingPlaceName(r.valgsted_navn || r.afstemningssted || r.sted_navn),
      kandidat_id,
      kandidat_navn: kandidatNavn,
      parti,
      parti_letter,
      stemmer: Number(r.stemmer||0)||0
    };
  });
}

/* NY: Indlæs et sæt kredse i samme storkreds */
async function loadKredsSet(storkreds, kredseArr){
  el("error").textContent=""; state.storkreds=storkreds; state.activeParty="";
  updateStorkredstitel();
  const s=encodeURIComponent(storkreds);
  const allRows=[];
  for(const kreds of kredseArr){
    const k = encodeURIComponent(kreds);
    const candidates=[
      `${BASE_PATH}${s}/${k}_allepartier.csv`,
      `${BASE_PATH}${s}/${k}.csv`
    ];
    let rows=null;
    for(const url of candidates){
      try{ rows = await fetchCsvCached(url); break; }catch(e){}
    }
    if(!rows){
      console.warn("Ingen data for", storkreds, kreds);
      continue;
    }
    allRows.push(...normalizeRows(rows, kreds));
  }
  state.rows = allRows;
  afterDataLoaded();
}

function afterDataLoaded(){ state.activeParty=""; renderPartyCombobox(); renderAll(); }

/* Parti-stats */
function detectPartyLetter(parti, rowsForParti){
  for(const r of rowsForParti){
    const L=(r.parti_letter||"").toUpperCase();
    if(L && PARTY_COLORS[L]) return L;
  }
  const key=parti.trim().toLowerCase();
  const mapped=PARTY_LETTERS_BY_NAME[key];
  if(mapped && PARTY_COLORS[mapped]) return mapped;
  return null;
}
function getPartyStats(){
  const byParti=new Map();
  for(const r of state.rows){
    if(!byParti.has(r.parti)) byParti.set(r.parti,[]);
    byParti.get(r.parti).push(r);
  }
  const res=[];
  for(const [parti,rows] of byParti.entries()){
    const map=new Map();
    for(const r of rows){
      if(!map.has(r.kandidat_id)) map.set(r.kandidat_id,{kandidat_id:r.kandidat_id,kandidat_navn:r.kandidat_navn,parti:r.parti,total:0});
      map.get(r.kandidat_id).total+=r.stemmer;
    }
    const kandidater=Array.from(map.values()).sort(sortKandidaterAlpha);
    const letter = detectPartyLetter(parti, rows);
    res.push({ parti, letter, hasLetter: !!letter, kandidatAntal: kandidater.filter(k=>!isListestemmer(k.kandidat_navn)).length, kandidater });
  }
  res.sort((a,b)=>{ if(a.hasLetter!==b.hasLetter) return a.hasLetter?-1:1; if(a.hasLetter&&b.hasLetter) return a.letter.localeCompare(b.letter,"da"); return a.parti.localeCompare(b.parti,"da"); });
  return res;
}

/* Parti-combobox */
function renderPartyCombobox(){
  const stats=getPartyStats(), btn=el("partyButton"), btnc=el("partyButtonContent"), menu=el("partyMenu");
  if(!stats.length){ btn.disabled=true; btnc.innerHTML=`<span class="vb-badge" style="background:#e5e7eb;color:#111827;border-color:#e5e7eb"> </span><span class="truncate text-gray-500">Ingen partier fundet</span>`; menu.innerHTML=""; return; }
  btn.disabled=false;

  function renderButton(){
    if(!state.activeParty){ btnc.innerHTML=`<span class="vb-badge" style="background:#e5e7eb;color:#111827;border-color:#e5e7eb"> </span><span class="truncate text-gray-500">Vælg parti…</span>`; return; }
    const cur=stats.find(s=>s.parti===state.activeParty);
    const {style,text}=badge(cur?.letter||null);
    btnc.innerHTML=`<span class="vb-badge" style="${style}">${text}</span><span class="truncate">${escapeHtml(state.activeParty)}</span>`;
  }
  function renderMenu(){
    menu.innerHTML=stats.map(s=>{
      const {style,text}=badge(s.letter); const sel=s.parti===state.activeParty;
      return `<div class="vb-option" role="option" data-parti="${escapeHtml(s.parti)}" aria-selected="${sel}">
                <span class="vb-badge" style="${style}">${text}</span>
                <span class="flex-1 truncate">${escapeHtml(s.parti)}</span>
                <span class="text-xs text-gray-500">${s.kandidatAntal} kandidater</span>
              </div>`;
    }).join("");
    menu.querySelectorAll('.vb-option').forEach((opt,i)=>{
      opt.onclick=()=>{ state.activeParty=opt.getAttribute('data-parti'); renderButton(); closePartyMenu(); renderPartyDetail(state.activeParty);
        menu.querySelectorAll('.vb-option').forEach((x,j)=>x.setAttribute('aria-selected', j===i)); };
    });
  }

  btn.onclick=()=>{ const open=btn.getAttribute('aria-expanded')==='true'; if(open) closePartyMenu(); else { renderMenu(); openPartyMenu(); } };
  function openPartyMenu(){ btn.setAttribute('aria-expanded','true'); menu.classList.remove('hidden'); menu.focus(); }
  function closePartyMenu(){ btn.setAttribute('aria-expanded','false'); menu.classList.add('hidden'); }
  window.closePartyMenu=closePartyMenu;

  renderButton();
  el("partyDetailHeader").textContent = "Vælg et parti i drop-down menuen.";
  el("candidateList").innerHTML = "";
}

/* Kandidatliste */
function renderPartyDetail(parti){
  const header=el("partyDetailHeader"), list=el("candidateList"); list.innerHTML="";
  if(!parti){ header.textContent="Vælg et parti i drop-down menuen."; return; }
  header.textContent=parti;

  const kandidaterAll=getPartyStats().find(x=>x.parti===parti)?.kandidater||[];
  const sorted=kandidaterAll.slice().sort(sortKandidaterAlpha);

  for(const k of sorted){
    const listestemmer = isListestemmer(k.kandidat_navn);
    const subtitle = listestemmer ? `${fmt(k.total)} listestemmer` : `${fmt(k.total)} stemmer i alt`;

    const row=document.createElement("div");
    row.className="rounded-xl border px-3 py-2 flex items-center justify-between";
    row.innerHTML=`<div>
                     <div class="font-medium">${escapeHtml(k.kandidat_navn)}</div>
                     <div class="text-xs text-gray-500">${escapeHtml(k.parti)} · ${subtitle}</div>
                   </div>
                   <button class="vb-btn" data-add="${k.kandidat_id}">Tilføj</button>`;
    row.querySelector("button[data-add]").onclick=()=>{ 
      state.selected.set(k.kandidat_id,{kandidat_id:k.kandidat_id,kandidat_navn:k.kandidat_navn,parti:k.parti});
      renderAll(); 
    };
    list.appendChild(row);
  }
}

/* Render alt / tabel / diagram */
function renderAll(){
  updateStorkredstitel();
  renderSelected();
  renderKredsTotals(getSelectedOrdered());
  renderPsTable(getPollingStations(), getSelectedOrdered());
  renderChart();
  const hasSel=getSelected().length>0;
  el("compareSection").classList.toggle("hidden",!hasSel);
  el("tabsCard").classList.toggle("hidden",!hasSel);
}

function updateStorkredstitel(){
  const list = Array.from(state.selectedKredse);
  const suffix = list.length ? ` – ${list.join(', ')}` : (state.kreds ? ` – ${state.kreds}` : "");
  el("storkredstitel").textContent = state.storkreds ? `(${state.storkreds}${suffix})` : "";
}

function stemmerLabel(n){ return n===1 ? "stemme" : "stemmer"; }
function computeTotalsByCandidate(){
  const m=new Map();
  for(const r of state.rows) m.set(r.kandidat_id,(m.get(r.kandidat_id)||0)+r.stemmer);
  return m;
}
function renderSelected(){
  const root=el("selectedList"), totals=computeTotalsByCandidate(), sel=getSelectedOrdered();
  function letterForParti(parti){ const stat=getPartyStats().find(s=>s.parti===parti); return stat?.letter||null; }

  root.innerHTML = sel.map(k=>{
    const letter=letterForParti(k.parti), bd=badge(letter);
    const total = totals.get(k.kandidat_id)||0;
    const listestemmer = isListestemmer(k.kandidat_navn);

    const totalTekst = listestemmer
      ? `${fmt(total)} ${total===1 ? 'listestemme' : 'listestemmer'}`
      : `${fmt(total)} personlige ${stemmerLabel(total)} i alt`;

    return `<div class="rounded-xl border p-3 flex items-center justify-between">
              <div class="flex items-center gap-3">
                <span class="vb-badge" style="${bd.style}">${bd.text}</span>
                <div class="font-medium">
                  ${escapeHtml(k.kandidat_navn)} <span class="text-gray-500">(${escapeHtml(k.parti)})</span>
                </div>
              </div>
              <div class="flex items-center gap-3">
                <div class="tabular-nums font-medium">${totalTekst}</div>
                <button class="vb-btn" onclick="removeCandidate('${k.kandidat_id}')">Fjern</button>
              </div>
            </div>`;
  }).join("") || `<div class="text-sm text-gray-500">Ingen kandidater valgt endnu.</div>`;

  el("btnClearAll").disabled = sel.length===0;
}
window.removeCandidate = id => { state.selected.delete(id); renderAll(); };
const getSelected = () => Array.from(state.selected.values());
const getSelectedOrdered = () => { const s=getSelected().slice(); s.sort(sortKandidaterAlpha); return s; };

/* Valgsteder: rækker pr. (kreds, valgsted) */
function getPollingStations(){
  const m=new Map();
  for(const r of state.rows){
    const key = `${r.kreds}::${r.valgsted_id}`;
    if(!m.has(key)) m.set(key,{id:key,navn:r.valgsted_navn,kreds:r.kreds});
    const ps=m.get(key);
    ps[r.kandidat_id]=(ps[r.kandidat_id]||0)+r.stemmer;
  }
  return Array.from(m.values()).sort((a,b)=>{
    if(a.kreds!==b.kreds) return a.kreds.localeCompare(b.kreds,"da");
    return a.navn.localeCompare(b.navn,"da");
  });
}

/* Tabel pr. valgsted – med Kreds-kolonne */
function renderPsTable(psList, sel){
  const thead=el("psThead"), tbody=el("psTbody"), tfoot=el("psTFoot");
  if(!sel.length){ thead.innerHTML=`<tr><th class="text-left py-2 pr-3">Valgsted</th><th class="text-left py-2 pr-3">Kreds</th></tr>`; tbody.innerHTML=""; tfoot.innerHTML=""; return; }
  const header = sel.map(s=>{
    const stat = getPartyStats().find(x=>x.parti===s.parti);
    const bd = badge(stat?.letter || null);
    return `<th class="py-2 pr-3"><div class="flex items-center gap-2">
              <span class="vb-badge" style="${bd.style};height:24px;width:24px;font-size:.75rem">${bd.text}</span>
              <span>${escapeHtml(s.kandidat_navn)} (${escapeHtml(s.parti)})</span></div></th>`;
  }).join("");
  thead.innerHTML=`<tr class="text-left border-b">
      <th class="py-2 pr-3">Valgsted</th>
      <th class="py-2 pr-3">Kreds</th>
      ${header}
    </tr>`;
  tbody.innerHTML=psList.map(ps=>`<tr class="border-b last:border-0">
    <td class="py-2 pr-3 font-medium">${escapeHtml(ps.navn)}</td>
    <td class="py-2 pr-3">${escapeHtml(ps.kreds || "")}</td>
    ${sel.map(s=>`<td class="py-2 pr-3 tabular-nums">${fmt(ps[s.kandidat_id]||0)}</td>`).join("")}
  </tr>`).join("");
  // Kredstotal (sum over PS) – vi holder os til total pr. kandidat (ikke pr. kreds) i tabel-foden
  const totals=computeTotalsByCandidate();
  tfoot.innerHTML=`<tr class="border-t">
    <th class="py-2 pr-3 text-left">Samlet</th>
    <th class="py-2 pr-3 text-left text-gray-500">(${fmt(psList.length)} rækker)</th>
    ${sel.map(s=>`<td class="py-2 pr-3 tabular-nums font-medium">${fmt(totals.get(s.kandidat_id)||0)}</td>`).join("")}
  </tr>`;
}

/* Kredstotaler (lille tabel over valgstedstabellen) */
function renderKredsTotals(sel){
  const wrap = el("kredsTotalsWrap"), thead=el("kredsTotalsThead"), tbody=el("kredsTotalsTbody");
  if(!sel.length || state.selectedKredse.size===0){ wrap.classList.add("hidden"); thead.innerHTML=""; tbody.innerHTML=""; return; }

  // Sum pr. (kreds, kandidat)
  const map = new Map(); // key: kreds -> Map(kandidat_id -> sum)
  for(const r of state.rows){
    const km = map.get(r.kreds) || new Map();
    km.set(r.kandidat_id, (km.get(r.kandidat_id)||0) + r.stemmer);
    map.set(r.kreds, km);
  }
  // Head
  const header = sel.map(s=>{
    const stat = getPartyStats().find(x=>x.parti===s.parti);
    const bd = badge(stat?.letter || null);
    return `<th class="py-2 pr-3 text-left">
              <div class="flex items-center gap-2">
                <span class="vb-badge" style="${bd.style};height:22px;width:22px;font-size:.7rem">${bd.text}</span>
                <span>${escapeHtml(s.kandidat_navn)} (${escapeHtml(s.parti)})</span>
              </div>
            </th>`;
  }).join("");
  thead.innerHTML = `<tr class="border-b">
    <th class="py-2 pr-3 text-left">Kreds</th>${header}
  </tr>`;

  // Body (kun de valgte kredse i chips-rækken; bevar rækkefølgen)
  const kredse = Array.from(state.selectedKredse).sort((a,b)=>a.localeCompare(b,"da"));
  tbody.innerHTML = kredse.map(k=>{
    const km = map.get(k) || new Map();
    return `<tr class="border-b last:border-0">
      <td class="py-2 pr-3 font-medium">${escapeHtml(k)}</td>
      ${sel.map(s=>`<td class="py-2 pr-3 tabular-nums">${fmt(km.get(s.kandidat_id)||0)}</td>`).join("")}
    </tr>`;
  }).join("");

  wrap.classList.remove("hidden");
}

/* Diagram */
function renderChart(){
  const canvas=document.getElementById("chart"), sel=getSelectedOrdered(); if(!sel.length){ resetChart(); return; }
  const ps=getPollingStations(), labels=ps.map(x=>`${x.kreds||""} · ${x.navn}`),
        datasets=sel.map(k=>({label:`${k.kandidat_navn} (${k.parti})`, data:ps.map(x=>x[k.kandidat_id]||0)}));
  if(state.chart) state.chart.destroy();
  state.chart=new Chart(canvas,{ type:"bar", data:{labels,datasets},
    options:{responsive:true,maintainAspectRatio:false,scales:{y:{beginAtZero:true,ticks:{precision:0}}}} });
}
function resetChart(){ if(state.chart){ state.chart.destroy(); state.chart=null; } }

/* Tabs */
function initTabs(){
  document.querySelectorAll("[data-tab]").forEach(b=>{
    b.onclick=()=>{ document.querySelectorAll(".vb-tabbox").forEach(x=>x.classList.remove("active"));
      b.classList.add('active');
      const t=b.getAttribute("data-tab");
      document.getElementById("tab-valgsted-tabel").classList.toggle("hidden",t!=="valgsted-tabel");
      document.getElementById("tab-valgsted-diagram").classList.toggle("hidden",t!=="valgsted-diagram");
    };
  });
}

function closePartyMenu(){ const btn=el('partyButton'), menu=el('partyMenu'); btn?.setAttribute('aria-expanded','false'); menu?.classList.add('hidden'); }
</script>
</body>
</html>
