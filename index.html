<!doctype html>
<html lang="da">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Kandidat‑Comparator (Kommunalvalg) – Web‑only</title>
  <!-- Tailwind via CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- PapaParse for CSV parsing -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <!-- Chart.js for charts -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <style>
    .chip { @apply inline-flex items-center gap-2 px-3 py-1 rounded-2xl border text-sm cursor-pointer select-none; }
    .chip.active { @apply bg-gray-900 text-white border-gray-900; }
  </style>
</head>
<body class="bg-gray-50 text-gray-900">
  <div class="mx-auto max-w-6xl p-4 space-y-4">
    <header class="flex items-center justify-between gap-4">
      <div>
        <h1 class="text-2xl font-semibold tracking-tight">Kandidat‑Comparator</h1>
        <p class="text-sm text-gray-600">Sammenlign kandidaters stemmetal på tværs af partier, kommuner og valgsteder. Kører direkte i din browser – ingen installation.</p>
      </div>
      <div class="flex items-center gap-2">
        <button id="btn-help" class="chip">Skema & hjælp</button>
        <button id="btn-template" class="chip">CSV‑skabelon</button>
      </div>
    </header>

    <!-- Data input -->
    <section class="bg-white rounded-2xl shadow-sm border p-4 space-y-3">
      <h2 class="font-medium">Data</h2>
      <div class="flex flex-col md:flex-row md:items-center gap-3">
        <input id="file" type="file" accept=".csv" class="block w-full md:w-auto" />
        <button id="btn-try-load" class="chip">Indlæs data/stemmer.csv</button>
        <span id="error" class="text-sm text-red-600"></span>
      </div>
      <p class="text-xs text-gray-500">Forventede kolonner (case‑insensitiv): <code>kommune, valgsted_id, valgsted_navn, kandidat_id, kandidat_navn, parti, stemmer</code></p>
    </section>

    <!-- Filtre -->
    <section class="bg-white rounded-2xl shadow-sm border p-4 space-y-3">
      <h2 class="font-medium">Filtre</h2>
      <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
        <div>
          <label class="text-sm font-medium">Kommune</label>
          <select id="kommune" class="w-full mt-1 rounded-xl border p-2"></select>
        </div>
        <div>
          <label class="text-sm font-medium">Partier</label>
          <div id="partiChips" class="mt-2 flex flex-wrap gap-2"></div>
        </div>
        <div>
          <label class="text-sm font-medium">Søg kandidat</label>
          <input id="search" class="w-full mt-1 rounded-xl border p-2" placeholder="Navn eller parti…" />
        </div>
      </div>
    </section>

    <!-- Vælg kandidater -->
    <section class="bg-white rounded-2xl shadow-sm border p-4 space-y-3">
      <div class="flex items-center justify-between">
        <h2 class="font-medium">Vælg kandidater til sammenligning</h2>
        <button id="btn-clear" class="chip">Nulstil valg</button>
      </div>
      <div id="kandidater" class="grid md:grid-cols-2 lg:grid-cols-3 gap-2 max-h-80 overflow-auto p-1"></div>
      <div class="text-sm text-gray-600">Valgt: <span id="selCount">0</span></div>
    </section>

    <!-- Tabs -->
    <section class="space-y-3">
      <div class="flex gap-2">
        <button class="chip active" data-tab="tabel">Tabel</button>
        <button class="chip" data-tab="diagram">Diagram</button>
      </div>
      <div id="tab-tabel" class="bg-white rounded-2xl shadow-sm border p-4">
        <h2 class="font-medium mb-2">Opsummering</h2>
        <div class="overflow-auto">
          <table class="w-full text-sm" id="summaryTable">
            <thead><tr class="text-left border-b">
              <th class="py-2 pr-2">Kandidat</th>
              <th class="py-2 pr-2">Parti</th>
              <th class="py-2 pr-2">Totale stemmer</th>
            </tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
      <div id="tab-diagram" class="bg-white rounded-2xl shadow-sm border p-4 hidden">
        <h2 class="font-medium mb-2">Stemmer pr. valgsted</h2>
        <canvas id="chart" height="140"></canvas>
      </div>
    </section>

    <footer class="pt-2 text-xs text-gray-500">Denne side kører 100% i browseren (Tailwind, PapaParse og Chart.js via CDN). Dine data forlader ikke din maskine.</footer>
  </div>

  <script>
    // ——— State ———
    const state = {
      rows: [], // {kommune, valgsted_id, valgsted_navn, kandidat_id, kandidat_navn, parti, stemmer}
      kommune: "",
      partiFilter: new Set(),
      search: "",
      selected: new Map(), // kandidat_id -> {kandidat_id, kandidat_navn, parti}
      chart: null,
    };

    const el = (id) => document.getElementById(id);

    // ——— Helpers ———
    function canonical(s){ return (s||"").toString().trim(); }
    function fmt(n){ return new Intl.NumberFormat('da-DK').format(n); }

    function parseCsv(text){
      el('error').textContent = '';
      const res = Papa.parse(text, { header: true, skipEmptyLines: true, transformHeader: h => canonical(h.toLowerCase()) });
      try {
        state.rows = res.data.map(r => ({
          kommune: canonical(r.kommune),
          valgsted_id: canonical(r.valgsted_id),
          valgsted_navn: canonical(r.valgsted_navn),
          kandidat_id: canonical(r.kandidat_id || r.kandidat_navn), // fallback hvis id mangler
          kandidat_navn: canonical(r.kandidat_navn),
          parti: canonical(r.parti),
          stemmer: Number(r.stemmer||0) || 0,
        }));
        bootstrapFilters();
        render();
      } catch(e){
        el('error').textContent = 'Kunne ikke læse CSV – tjek kolonner og formater.';
      }
    }

    async function tryLoadDefault(){
      el('error').textContent = '';
      const candidates = [
        'data/stemmer.csv',
        'data/Bornholm_alle_partier.csv',
        'data/bornholm.csv'
      ];
      for(const url of candidates){
        try{
          const r = await fetch(url, { cache: 'no-store' });
          if(!r.ok) throw new Error('HTTP '+r.status);
          const text = await r.text();
          parseCsv(text);
          return; // success
        }catch(err){ /* try next */ }
      }
      el('error').textContent = 'Kunne ikke indlæse data automatisk. Tjek at en CSV ligger i /data som fx stemmer.csv';
    }
    }

    function bootstrapFilters(){
      // Kommuner
      const kommuner = Array.from(new Set(state.rows.map(r=>r.kommune))).sort();
      const sel = el('kommune');
      sel.innerHTML = '<option value="">Alle</option>' + kommuner.map(k=>`<option>${k}</option>`).join('');
      if(kommuner.length===1){ sel.value = kommuner[0]; state.kommune = kommuner[0]; }
      // Partier
      renderPartiChips();
      // Kandidater liste
      renderKandidater();
    }

    function renderPartiChips(){
      const root = el('partiChips');
      const partier = Array.from(new Set(state.rows.filter(r=>!state.kommune || r.kommune===state.kommune).map(r=>r.parti))).sort();
      root.innerHTML = '';
      partier.forEach(p => {
        const b = document.createElement('button');
        b.className = 'chip' + (state.partiFilter.has(p) ? ' active' : '');
        b.textContent = p || '(ukendt)';
        b.onclick = ()=>{ if(state.partiFilter.has(p)) state.partiFilter.delete(p); else state.partiFilter.add(p); render(); };
        root.appendChild(b);
      });
    }

    function getKandidater(){
      const seen = new Set();
      const list = [];
      for(const r of state.rows){
        if(state.kommune && r.kommune !== state.kommune) continue;
        if(state.partiFilter.size && !state.partiFilter.has(r.parti)) continue;
        if(!seen.has(r.kandidat_id)){
          seen.add(r.kandidat_id);
          list.push({ kandidat_id: r.kandidat_id, kandidat_navn: r.kandidat_navn, parti: r.parti });
        }
      }
      const q = state.search.toLowerCase();
      return list
        .filter(k=> !q || (k.kandidat_navn + ' ' + k.parti).toLowerCase().includes(q))
        .sort((a,b)=> a.kandidat_navn.localeCompare(b.kandidat_navn,'da'));
    }

    function renderKandidater(){
      const root = el('kandidater');
      const list = getKandidater();
      root.innerHTML = '';
      if(list.length===0){ root.innerHTML = '<div class="text-sm text-gray-500">Ingen kandidater matcher dine filtre endnu.</div>'; return; }
      for(const k of list){
        const checked = state.selected.has(k.kandidat_id);
        const div = document.createElement('label');
        div.className = 'flex items-center gap-2 rounded-xl border p-2 hover:bg-gray-50 cursor-pointer';
        div.innerHTML = `<input type="checkbox" ${checked?'checked':''} class="h-4 w-4">`+
                        `<div class="flex flex-col"><span class="font-medium">${k.kandidat_navn}</span><span class="text-xs text-gray-500">${k.parti}</span></div>`;
        div.querySelector('input').onchange = (e)=>{ toggleCandidate(k); };
        root.appendChild(div);
      }
      el('selCount').textContent = state.selected.size;
    }

    function toggleCandidate(k){
      if(state.selected.has(k.kandidat_id)) state.selected.delete(k.kandidat_id);
      else state.selected.set(k.kandidat_id, k);
      el('selCount').textContent = state.selected.size;
      renderSummary();
      renderChart();
      renderKandidater();
    }

    function render(){
      renderPartiChips();
      renderKandidater();
      renderSummary();
      renderChart();
    }

    function computeTotals(){
      const totals = new Map(); // kandidat_id -> total
      for(const r of state.rows){
        if(state.kommune && r.kommune !== state.kommune) continue;
        totals.set(r.kandidat_id, (totals.get(r.kandidat_id)||0) + r.stemmer);
      }
      return totals;
    }

    function renderSummary(){
      const totals = computeTotals();
      const tbody = document.querySelector('#summaryTable tbody');
      const selectedList = Array.from(state.selected.values()).map(k=>({ ...k, total: totals.get(k.kandidat_id)||0 }))
                                .sort((a,b)=> b.total - a.total);
      tbody.innerHTML = selectedList.map(s=> `<tr class="border-b last:border-0">
        <td class="py-2 pr-2">${s.kandidat_navn}</td>
        <td class="py-2 pr-2">${s.parti}</td>
        <td class="py-2 pr-2 tabular-nums">${fmt(s.total)}</td>
      </tr>`).join('') || `<tr><td colspan="3" class="py-6 text-center text-gray-500">Vælg mindst én kandidat ovenfor.</td></tr>`;
    }

    function dataByPollingStation(){
      const map = new Map(); // id -> {navn, id, [kandidat_id]: stemmer}
      for(const r of state.rows){
        if(state.kommune && r.kommune !== state.kommune) continue;
        if(!map.has(r.valgsted_id)) map.set(r.valgsted_id, { id: r.valgsted_id, navn: r.valgsted_navn });
        const ps = map.get(r.valgsted_id);
        ps[r.kandidat_id] = (ps[r.kandidat_id]||0) + r.stemmer;
      }
      return Array.from(map.values()).sort((a,b)=> a.navn.localeCompare(b.navn,'da'));
    }

    function renderChart(){
      const canvas = el('chart');
      const ps = dataByPollingStation();
      const selected = Array.from(state.selected.values());
      if(!selected.length){ canvas.replaceWith(canvas.cloneNode(true)); // clear old canvas
        const newCanvas = el('tab-diagram').querySelector('canvas');
        state.chart = null; return; }

      const labels = ps.map(x=> x.navn);
      const datasets = selected.map((k, idx) => ({
        label: `${k.kandidat_navn} (${k.parti})`,
        data: ps.map(x=> x[k.kandidat_id] || 0),
      }));

      if(state.chart){ state.chart.destroy(); }
      state.chart = new Chart(canvas, {
        type: 'bar',
        data: { labels, datasets },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: { y: { beginAtZero: true, ticks: { precision: 0 } } },
        }
      });
    }

    // ——— Events ———
    el('file').addEventListener('change', (e)=>{
      const f = e.target.files && e.target.files[0];
      if(!f) return;
      const reader = new FileReader();
      reader.onload = () => parseCsv(String(reader.result));
      reader.readAsText(f, 'utf-8');
    });
    el('btn-try-load').onclick = tryLoadDefault;
    // Auto-indlæs data/stemmer.csv når siden åbnes
    window.addEventListener('DOMContentLoaded', tryLoadDefault);
    el('kommune').onchange = (e)=>{ state.kommune = e.target.value; render(); };
    el('search').oninput = (e)=>{ state.search = e.target.value; renderKandidater(); };
    el('btn-clear').onclick = ()=>{ state.selected.clear(); render(); };

    // Tabs
    for(const b of document.querySelectorAll('[data-tab]')){
      b.onclick = ()=>{
        document.querySelectorAll('[data-tab]').forEach(x=>x.classList.remove('active'));
        b.classList.add('active');
        const t = b.getAttribute('data-tab');
        document.getElementById('tab-tabel').classList.toggle('hidden', t!=='tabel');
        document.getElementById('tab-diagram').classList.toggle('hidden', t!=='diagram');
      };
    }

    // Help + template
    el('btn-help').onclick = ()=>{
      alert('CSV‑skema:\nkommune, valgsted_id, valgsted_navn, kandidat_id, kandidat_navn, parti, stemmer\n\nLæg evt. filen i data/stemmer.csv på dit site, eller brug fil‑upload.');
    };
    el('btn-template').onclick = ()=>{
      const csv = [
        ['kommune','valgsted_id','valgsted_navn','kandidat_id','kandidat_navn','parti','stemmer'].join(','),
        ['Bornholm','1','Allinge','9001','Anne Jensen','A',6].join(','),
        ['Bornholm','1','Allinge','9002','Bente Helms','V',10].join(',')
      ].join('\n');
      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = 'stemmer_skabelon.csv';
      document.body.appendChild(a); a.click(); document.body.removeChild(a);
      URL.revokeObjectURL(url);
    };
  </script>
</body>
</html>
