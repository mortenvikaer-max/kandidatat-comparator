<!doctype html>
<html lang="da">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>KV – Kandidater & partier</title>

  <!-- Tailwind CSS (CDN) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- PapaParse -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

  <style>
    .chip { @apply inline-flex items-center gap-2 px-3 py-1 rounded-2xl border text-sm cursor-pointer select-none; }
    .chip.active { @apply bg-gray-900 text-white border-gray-900; }
    .card { @apply bg-white rounded-2xl shadow-sm border; }
    .btn  { @apply inline-flex items-center gap-2 rounded-xl border px-3 py-2; }
    .btn:disabled { @apply opacity-50 cursor-not-allowed; }
    .table-sticky thead th:first-child, .table-sticky tbody td:first-child { position: sticky; left: 0; background: white; }
  </style>
</head>

<body class="bg-gray-50 text-gray-900">
  <!-- HERO -->
  <section class="bg-gradient-to-b from-gray-900 to-gray-800 text-white">
    <div class="mx-auto max-w-6xl px-4 py-10">
      <div class="text-3xl md:text-4xl font-extrabold tracking-tight">Valgresultater – Kommunalvalg 2021</div>
      <div class="mt-2 text-white/80">Vælg en kommune og få overblik over partier, kandidater og stemmer.</div>

      <!-- Kommunevælger i hero -->
      <div class="mt-6 grid grid-cols-1 md:grid-cols-3 gap-3">
        <div>
          <label class="text-sm text-white/80">Region</label>
          <select id="regionSelect" class="w-full mt-1 rounded-xl border p-2 text-gray-900"></select>
        </div>
        <div class="md:col-span-2">
          <label class="text-sm text-white/80">Kommune</label>
          <select id="kommuneSelect" class="w-full mt-1 rounded-xl border p-2 text-gray-900" disabled></select>
        </div>
      </div>

      <div id="error" class="mt-3 text-sm text-red-200"></div>
    </div>
  </section>

  <!-- HOVEDINDHOLD -->
  <main class="mx-auto max-w-6xl p-4 space-y-6">

    <!-- PARTI-OVERSIGT: to-panel layout -->
    <section>
      <div class="flex items-center justify-between mb-3">
        <h2 class="text-xl font-semibold">Partier og kandidater</h2>
        <div id="kommunetitel" class="text-gray-500"></div>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
        <!-- Venstre panel: partier -->
        <aside class="space-y-2 md:col-span-1" id="partyList"></aside>

        <!-- Højre panel: kandidater for valgt parti -->
        <section class="md:col-span-2 card p-4 space-y-3" id="partyDetail">
          <div id="partyDetailHeader" class="text-gray-500 text-sm">Vælg et parti i venstre panel for at se kandidater.</div>
          <div id="candidateList" class="space-y-2"></div>
        </section>
      </div>
    </section>

    <!-- VALGTE KANDIDATER (chips) -->
    <section class="card p-4 space-y-3">
      <h2 class="font-medium">Kandidat-sammenligning</h2>
      <div id="selectedChips" class="flex flex-wrap gap-2"></div>
    </section>

    <!-- OPSUMMERING -->
    <section class="card p-4 space-y-3">
      <h2 class="font-medium">Opsummering (samlede stemmer)</h2>
      <div class="overflow-auto">
        <table class="w-full text-sm" id="summaryTable">
          <thead>
            <tr class="text-left border-b">
              <th class="py-2 pr-2">Kandidat</th>
              <th class="py-2 pr-2">Parti</th>
              <th class="py-2 pr-2">Totale stemmer</th>
              <th class="py-2 pr-2"></th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </section>

    <!-- TABS: Tabel / Diagram pr. valgsted -->
    <section class="space-y-3">
      <div class="flex gap-2">
        <button class="chip active" data-tab="valgsted-tabel">Tabel pr. valgsted</button>
        <button class="chip" data-tab="valgsted-diagram">Diagram pr. valgsted</button>
      </div>

      <div id="tab-valgsted-tabel" class="card p-4">
        <h2 class="font-medium mb-2">Sammenligning pr. valgsted</h2>
        <div class="overflow-auto">
          <table class="table-sticky w-full text-sm min-w-[640px]" id="psTable">
            <thead id="psThead"></thead>
            <tbody id="psTbody"></tbody>
            <tfoot id="psTFoot"></tfoot>
          </table>
        </div>
        <p class="text-xs text-gray-500 mt-2">Tip: Scroll vandret for at se alle kandidater, hvis der vælges mange.</p>
      </div>

      <div id="tab-valgsted-diagram" class="card p-4 hidden">
        <h2 class="font-medium mb-2">Diagram – stemmer pr. valgsted</h2>
        <div style="height: 420px"><canvas id="chart"></canvas></div>
      </div>
    </section>

    <footer class="pt-2 text-xs text-gray-500">
      Kører 100% i browseren. Dine data forlader ikke din maskine.
    </footer>
  </main>

  <script>
    // ——— Fejlvisning ———
    window.addEventListener('error', (e) => {
      const box = document.getElementById('error');
      if (box) box.textContent = 'Fejl i JavaScript: ' + e.message;
    });

    // ——— Regioner & kommuner ———
    const REGIONS = {
      "Region Hovedstaden": ["Albertslund","Allerød","Ballerup","Bornholm","Brøndby","Dragør","Egedal","Fredensborg","Frederiksberg","Frederikssund","Furesø","Gentofte","Gladsaxe","Glostrup","Gribskov","Halsnæs","Herlev","Hillerød","Hvidovre","Høje-Taastrup","Hørsholm","Ishøj","København","Lyngby-Taarbæk","Rudersdal","Rødovre","Tårnby","Vallensbæk"],
      "Region Sjælland": ["Faxe","Greve","Guldborgsund","Holbæk","Kalundborg","Køge","Lejre","Lolland","Næstved","Odsherred","Ringsted","Roskilde","Slagelse","Solrød","Sorø","Stevns","Vordingborg"],
      "Region Syddanmark": ["Assens","Billund","Esbjerg","Fanø","Fredericia","Faaborg-Midtfyn","Haderslev","Kerteminde","Kolding","Langeland","Middelfart","Nordfyns","Nyborg","Odense","Svendborg","Tønder","Varde","Vejen","Vejle","Ærø","Aabenraa","Sønderborg"],
      "Region Midtjylland": ["Favrskov","Hedensted","Herning","Holstebro","Horsens","Ikast-Brande","Lemvig","Norddjurs","Odder","Randers","Ringkøbing-Skjern","Samsø","Silkeborg","Skanderborg","Skive","Struer","Syddjurs","Viborg","Aarhus"],
      "Region Nordjylland": ["Brønderslev","Frederikshavn","Hjørring","Jammerbugt","Læsø","Mariagerfjord","Morsø","Rebild","Thisted","Vesthimmerlands","Aalborg"]
    };

    // ——— PARTIFARVER (efter bogstav) ———
    const PARTY_COLORS = {
      // Landsdækkende
      "A": "#e03a3e", // Socialdemokratiet
      "B": "#712082", // Radikale Venstre (mørk lilla)
      "C": "#2e7d32", // Konservative
      "D": "#0f766e", // Nye Borgerlige (teal-ish)
      "F": "#e5003d", // SF
      "I": "#00a0e3", // Liberal Alliance
      "O": "#0044aa", // Dansk Folkeparti
      "V": "#1b5eaa", // Venstre
      "Ø": "#c8102e", // Enhedslisten
      "Å": "#3aaa35", // Alternativet
      "Q": "#ff4fa3", // Feministisk Initiativ
      "K": "#ff9800", // KD (fallback)
      "Æ": "#666666"  // evt. brugt af lokale – neutral mørk
      // Ukendte/lokallister -> default nedenfor
    };
    const DEFAULT_BADGE_BG = "#e5e7eb"; // Tailwind gray-200
    const DEFAULT_BADGE_FG = "#111827"; // gray-900

    // ——— STATE ———
    const state = {
      rows: [],
      region: "", kommune: "",
      activeParty: "",
      selected: new Map(),
      chart: null,
      showAll: {}
    };

    // ——— Helpers ———
    const el = (id) => document.getElementById(id);
    const fmt = (n) => new Intl.NumberFormat("da-DK").format(n);
    const canon = (s) => (s||"").toString().trim();
    const escapeHtml = (s) => (s||"").replace(/[&<>"]/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c]));
    const isListestemmer = (name) => canon(name).toLowerCase() === "listestemmer";
    const sortKandidaterAlpha = (a,b) => {
      const al = isListestemmer(a.kandidat_navn), bl = isListestemmer(b.kandidat_navn);
      if (al && !bl) return 1;        // Listestemmer til sidst
      if (!al && bl) return -1;
      return a.kandidat_navn.localeCompare(b.kandidat_navn, "da");
    };
    const partiLetter = (kid) => {
      const p = (kid||"").split("_")[0];
      return p ? p.toUpperCase() : "•";
    };
    function badgeStyleForLetter(letter){
      const bg = PARTY_COLORS[letter] || DEFAULT_BADGE_BG;
      const isDefault = !(letter in PARTY_COLORS);
      // enkel kontrastregel: mørk tekst ved default lys baggrund, ellers hvid
      const fg = isDefault ? DEFAULT_BADGE_FG : "#ffffff";
      return `background-color:${bg}; color:${fg}; border-color:${bg}`;
    }

    // ——— INIT ———
    window.addEventListener("DOMContentLoaded", () => {
      initRegionDropdown();
      initTabs();

      const p = new URLSearchParams(location.search);
      const r = p.get("region");
      const k = p.get("kommune");
      if (r && REGIONS[r]) {
        el("regionSelect").value = r;
        populateKommuner(r);
        if (k && REGIONS[r].includes(k)) {
          el("kommuneSelect").value = k;
          loadKommuneData(k);
        }
      }
    });

    // ——— Dropdowns ———
    function initRegionDropdown(){
      const rsel = el("regionSelect");
      rsel.innerHTML = `<option value="">Vælg region…</option>` +
        Object.keys(REGIONS).map(r=>`<option value="${r}">${r}</option>`).join("");
      rsel.onchange = ()=>{
        const r = rsel.value;
        state.region = r; state.kommune=""; state.activeParty="";
        el("kommuneSelect").disabled = !r;
        el("kommuneSelect").innerHTML = `<option value="">Vælg kommune…</option>`;
        if (r) populateKommuner(r);
        clearAll();
      };
      el("kommuneSelect").disabled = true;
    }
    function populateKommuner(region){
      const ksel = el("kommuneSelect");
      const kommuner = REGIONS[region]||[];
      ksel.innerHTML = `<option value="">Vælg kommune…</option>`+
        kommuner.map(k=>`<option value="${k}">${k}</option>`).join("");
      ksel.onchange = ()=>{
        const k = ksel.value;
        state.kommune = k; state.activeParty="";
        clearAll();
        if (k){
          const u = new URL(location.href); u.searchParams.set("region", state.region); u.searchParams.set("kommune", k);
          history.replaceState({}, "", u);
          loadKommuneData(k);
        }
      };
    }

    function clearAll(){
      state.rows = []; state.selected.clear();
      el("partyList").innerHTML = "";
      el("partyDetailHeader").textContent = "Vælg et parti i venstre panel for at se kandidater.";
      el("candidateList").innerHTML = "";
      el("kommunetitel").textContent = "";
      renderSelected(); renderSummary(); renderPsTable([], []); resetChart();
    }

    // ——— Data ———
    async function loadKommuneData(k){
      el("error").textContent = "";
      el("kommunetitel").textContent = k ? `(${k})` : "";
      const safe = encodeURIComponent(k);
      const candidates = [`data/${safe}_allepartier.csv`, `data/${safe}.csv`];
      for (const url of candidates){
        try{
          const r = await fetch(url, {cache:"no-store"});
          if (!r.ok) throw new Error("HTTP "+r.status);
          const text = await r.text();
          parseCsv(text);
          afterDataLoaded();
          return;
        }catch(e){}
      }
      el("error").textContent = `Kunne ikke finde data for ${k}. Forventede fx /data/${k}_allepartier.csv`;
    }
    function parseCsv(text){
      const res = Papa.parse(text, {header:true, skipEmptyLines:true, transformHeader:h=>canon(h.toLowerCase())});
      state.rows = res.data.map(r=>({
        kommune: canon(r.kommune),
        valgsted_id: canon(r.valgsted_id),
        valgsted_navn: canon(r.valgsted_navn),
        kandidat_id: canon(r.kandidat_id || r.kandidat_navn),
        kandidat_navn: canon(r.kandidat_navn),
        parti: canon(r.parti),
        stemmer: Number(r.stemmer||0)||0
      }));
    }
    function afterDataLoaded(){
      renderPartyOverview();
      renderSelected();
      renderSummary();
      renderPsTable(getPollingStations(), getSelectedOrdered());
      renderChart();
    }

    // ——— Parti-oversigt (venstre panel) ———
    function getPartyStats(){
      const byParti = new Map();
      for (const r of state.rows){
        if (!byParti.has(r.parti)) byParti.set(r.parti, []);
        byParti.get(r.parti).push(r);
      }
      const res = [];
      for (const [parti, rows] of byParti.entries()){
        const candMap = new Map();
        let partyTotal = 0, personalTotal = 0;
        for (const r of rows){
          partyTotal += r.stemmer;
          if (!candMap.has(r.kandidat_id)){
            candMap.set(r.kandidat_id, {kandidat_id:r.kandidat_id, kandidat_navn:r.kandidat_navn, parti:r.parti, total:0});
          }
          candMap.get(r.kandidat_id).total += r.stemmer;
        }
        const kandidater = Array.from(candMap.values()).sort(sortKandidaterAlpha);
        for (const k of kandidater){ if (!isListestemmer(k.kandidat_navn)) personalTotal += k.total; }
        res.push({
          parti,
          letter: partiLetter(kandidater[0]?.kandidat_id || ""),
          kandidatAntal: kandidater.filter(k=>!isListestemmer(k.kandidat_navn)).length,
          personalTotal,
          partyTotal,
          kandidater
        });
      }
      // ★ Sortér alfabetisk efter bogstav (da-DK, så Æ/Ø/Å lander korrekt)
      res.sort((a,b)=> a.letter.localeCompare(b.letter, "da"));
      return res;
    }

    function renderPartyOverview(){
      const host = el("partyList");
      host.innerHTML = "";
      const stats = getPartyStats();
      if (!stats.length){
        host.innerHTML = `<div class="text-sm text-gray-500">Vælg en kommune for at se partier.</div>`;
        return;
      }
      for (const p of stats){
        const div = document.createElement("div");
        const style = badgeStyleForLetter(p.letter);
        div.className = `flex items-center justify-between rounded-xl border px-3 py-2 cursor-pointer hover:bg-gray-100 transition ${
          state.activeParty === p.parti ? "bg-gray-100 border-gray-400" : "border-gray-200"
        }`;
        div.innerHTML = `
          <div class="flex items-center gap-3">
            <div class="h-9 w-9 rounded-full border flex items-center justify-center font-semibold" style="${style}">
              ${escapeHtml(p.letter)}
            </div>
            <div>
              <div class="font-medium">${escapeHtml(p.parti)}</div>
              <div class="text-xs text-gray-500">${p.kandidatAntal} kandidater · ${fmt(p.personalTotal)} personlige · ${fmt(p.partyTotal)} i alt</div>
            </div>
          </div>`;
        div.addEventListener("click", ()=>{
          state.activeParty = p.parti;
          renderPartyOverview();
          renderPartyDetail(p.parti);
        });
        host.appendChild(div);
      }
      if (!state.activeParty && stats.length){
        state.activeParty = stats[0].parti;
        renderPartyOverview();
        renderPartyDetail(state.activeParty);
      }
    }

    // ——— Højre panel: kandidater for valgt parti (alfabetisk, Listestemmer sidst) ———
    function renderPartyDetail(parti){
      const header = el("partyDetailHeader");
      const list = el("candidateList");
      list.innerHTML = "";
      if (!parti){
        header.textContent = "Vælg et parti i venstre panel for at se kandidater.";
        return;
      }
      header.textContent = parti;

      const kandidaterAll = getPartyStats().find(x => x.parti === parti)?.kandidater || [];
      // ★ Altid alfabetisk (med Listestemmer til sidst)
      const sorted = kandidaterAll.slice().sort(sortKandidaterAlpha);

      for (const k of sorted){
        const disabled = isListestemmer(k.kandidat_navn) ? "opacity-60" : "";
        const btnDis   = isListestemmer(k.kandidat_navn) ? "disabled" : "";
        const row = document.createElement("div");
        row.className = `flex items-center justify-between rounded-xl border px-3 py-2 ${disabled}`;
        row.innerHTML = `
          <div>
            <div class="font-medium">${escapeHtml(k.kandidat_navn)}</div>
            <div class="text-xs text-gray-500">${escapeHtml(k.parti)} · ${fmt(k.total)} personlige stemmer</div>
          </div>
          <button class="btn" ${btnDis} data-add="${k.kandidat_id}">Tilføj</button>
        `;
        row.querySelector("button[data-add]")?.addEventListener("click", ()=>{
          state.selected.set(k.kandidat_id, {kandidat_id:k.kandidat_id, kandidat_navn:k.kandidat_navn, parti:k.parti});
          renderSelected(); renderSummary(); renderPsTable(getPollingStations(), getSelectedOrdered()); renderChart();
        });
        list.appendChild(row);
      }
    }

    // ——— Valgte kandidater (chips) ———
    function renderSelected(){
      const root = el("selectedChips");
      const sel = getSelectedOrdered();
      root.innerHTML = sel.map(k => `
        <span class="chip">
          ${escapeHtml(k.kandidat_navn)} (${escapeHtml(k.parti)})
          <button class="ml-1" aria-label="Fjern" onclick="removeCandidate('${k.kandidat_id}')">✕</button>
        </span>
      `).join("") || `<span class="text-sm text-gray-500">Ingen kandidater valgt endnu.</span>`;
    }
    window.removeCandidate = (kid)=>{ state.selected.delete(kid); renderSelected(); renderSummary(); renderPsTable(getPollingStations(), getSelectedOrdered()); renderChart(); };
    function getSelected(){ return Array.from(state.selected.values()); }
    function getSelectedOrdered(){ const s = getSelected().slice(); s.sort(sortKandidaterAlpha); return s; }

    // ——— Opsummering (totale pr. kandidat) ———
    function computeTotalsByCandidate(){
      const totals = new Map();
      for (const r of state.rows) totals.set(r.kandidat_id, (totals.get(r.kandidat_id)||0) + r.stemmer);
      return totals;
    }
    function renderSummary(){
      const totals = computeTotalsByCandidate();
      const tbody = document.querySelector("#summaryTable tbody");
      const selected = getSelectedOrdered().map(k => ({...k, total: totals.get(k.kandidat_id)||0}));
      tbody.innerHTML =
        selected.map(s=>`
          <tr class="border-b last:border-0">
            <td class="py-2 pr-2">${escapeHtml(s.kandidat_navn)}</td>
            <td class="py-2 pr-2">${escapeHtml(s.parti)}</td>
            <td class="py-2 pr-2 tabular-nums">${fmt(s.total)}</td>
            <td class="py-2 pr-2"><button class="btn" onclick="removeCandidate('${s.kandidat_id}')">Fjern</button></td>
          </tr>
        `).join("") ||
        `<tr><td colspan="4" class="py-6 text-center text-gray-500">Vælg kandidater ovenfor.</td></tr>`;
    }

    // ——— Valgstedstabel og diagram ———
    function getPollingStations(){
      const m = new Map();
      for (const r of state.rows){
        if (!m.has(r.valgsted_id)) m.set(r.valgsted_id, { id:r.valgsted_id, navn:r.valgsted_navn });
        const ps = m.get(r.valgsted_id);
        ps[r.kandidat_id] = (ps[r.kandidat_id]||0) + r.stemmer;
      }
      return Array.from(m.values()).sort((a,b)=> a.navn.localeCompare(b.navn,"da"));
    }
    function renderPsTable(psList, sel){
      const thead = el("psThead"), tbody = el("psTbody"), tfoot = el("psTFoot");
      if (!sel.length){
        thead.innerHTML = `<tr><th class="text-left py-2 pr-3">Valgsted</th></tr>`;
        tbody.innerHTML = `<tr><td class="py-4 text-center text-gray-500" colspan="1">Vælg mindst én kandidat.</td></tr>`;
        tfoot.innerHTML = ""; return;
      }
      thead.innerHTML = `
        <tr class="text-left border-b">
          <th class="py-2 pr-3 bg-white">Valgsted</th>
          ${sel.map(s=>`<th class="py-2 pr-3">${escapeHtml(s.kandidat_navn)} (${escapeHtml(s.parti)})</th>`).join("")}
        </tr>`;
      tbody.innerHTML = psList.map(ps=>{
        const cells = sel.map(s=> ps[s.kandidat_id]||0 );
        return `<tr class="border-b last:border-0">
          <td class="py-2 pr-3 font-medium bg-white">${escapeHtml(ps.navn)}</td>
          ${cells.map(v=>`<td class="py-2 pr-3 tabular-nums">${fmt(v)}</td>`).join("")}
        </tr>`;
      }).join("");
      const totals = computeTotalsByCandidate();
      const foot = sel.map(s=> `<td class="py-2 pr-3 tabular-nums font-medium">${fmt(totals.get(s.kandidat_id)||0)}</td>`).join("");
      tfoot.innerHTML = `<tr class="border-t"><th class="py-2 pr-3 text-left bg-white">Kommunetotal</th>${foot}</tr>`;
    }

    function renderChart(){
      const canvas = document.getElementById("chart");
      const sel = getSelectedOrdered();
      if (!sel.length){ resetChart(); return; }
      const ps = getPollingStations();
      const labels = ps.map(x=>x.navn);
      const datasets = sel.map(k=>({ label:`${k.kandidat_navn} (${k.parti})`, data: ps.map(x=> x[k.kandidat_id]||0) }));
      if (state.chart) state.chart.destroy();
      state.chart = new Chart(canvas, {
        type:"bar",
        data:{ labels, datasets },
        options:{ responsive:true, maintainAspectRatio:false, scales:{ y:{ beginAtZero:true, ticks:{ precision:0 } } } }
      });
    }
    function resetChart(){ if (state.chart){ state.chart.destroy(); state.chart=null; } }

    // ——— Tabs ———
    function initTabs(){
      for (const b of document.querySelectorAll("[data-tab]")){
        b.onclick = ()=>{
          document.querySelectorAll("[data-tab]").forEach(x=>x.classList.remove("active"));
          b.classList.add("active");
          const t = b.getAttribute("data-tab");
          document.getElementById("tab-valgsted-tabel").classList.toggle("hidden", t!=="valgsted-tabel");
          document.getElementById("tab-valgsted-diagram").classList.toggle("hidden", t!=="valgsted-diagram");
        };
      }
    }
  </script>
</body>
</html>
