<!doctype html>
<html lang="da">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Kandidat-Comparator – Kommunalvalg</title>

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- PapaParse -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

  <style>
    .chip { @apply inline-flex items-center gap-2 px-3 py-1 rounded-2xl border text-sm cursor-pointer select-none; }
    .chip.active { @apply bg-gray-900 text-white border-gray-900; }
    .table-sticky thead th:first-child, .table-sticky tbody td:first-child { position: sticky; left: 0; background: white; }
    .btn { @apply inline-flex items-center gap-2 rounded-xl border px-3 py-2; }
    .btn:disabled { @apply opacity-50 cursor-not-allowed; }
  </style>
</head>

<body class="bg-gray-50 text-gray-900">
  <div class="mx-auto max-w-6xl p-4 space-y-4">
    <header class="flex items-center justify-between gap-4">
      <div>
        <h1 class="text-2xl font-semibold tracking-tight">Kandidat-Comparator</h1>
        <p class="text-sm text-gray-600">
          Vælg <strong>region</strong> → <strong>kommune</strong> → tilføj kandidater (fra ét eller flere partier) til sammenligning.
          Der vises stemmer på <span class="font-medium">alle valgsteder i kommunen</span>.
          Data hentes fra <code>/data/&lt;Kommune&gt;_allepartier.csv</code> (eller <code>/data/&lt;Kommune&gt;.csv</code>).
        </p>
      </div>
      <button id="btn-help" class="chip">Skema & hjælp</button>
    </header>

    <!-- 1) Region & kommune -->
    <section class="bg-white rounded-2xl shadow-sm border p-4 space-y-3">
      <h2 class="font-medium">Vælg region og kommune</h2>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
        <div>
          <label class="text-sm font-medium">Region</label>
          <select id="regionSelect" class="w-full mt-1 rounded-xl border p-2"></select>
        </div>
        <div>
          <label class="text-sm font-medium">Kommune</label>
          <select id="kommuneSelect" class="w-full mt-1 rounded-xl border p-2" disabled></select>
        </div>
      </div>
      <span id="error" class="text-sm text-red-600"></span>
    </section>

    <!-- 2) Tilføj kandidater til sammenligning (på tværs af partier) -->
    <section class="bg-white rounded-2xl shadow-sm border p-4 space-y-4">
      <h2 class="font-medium">Tilføj kandidat til sammenligning</h2>
      <div class="flex flex-wrap items-end gap-3">
        <div>
          <label class="text-sm font-medium">Parti</label>
          <select id="cmpParti" class="w-56 rounded-xl border p-2" disabled></select>
        </div>
        <div>
          <label class="text-sm font-medium">Kandidat</label>
          <select id="cmpKandidat" class="w-72 rounded-xl border p-2" disabled>
            <option value="">Vælg kandidat…</option>
          </select>
        </div>
        <button id="btn-add" class="btn" disabled>Tilføj</button>
        <button id="btn-clear" class="btn">Nulstil valg</button>
      </div>

      <!-- Valgte kandidater som chips -->
      <div id="selectedChips" class="flex flex-wrap gap-2"></div>
    </section>

    <!-- 3) Opsummering – samlede stemmer pr. kandidat -->
    <section class="bg-white rounded-2xl shadow-sm border p-4 space-y-3">
      <h2 class="font-medium">Opsummering (samlede stemmer)</h2>
      <div class="overflow-auto">
        <table class="w-full text-sm" id="summaryTable">
          <thead>
            <tr class="text-left border-b">
              <th class="py-2 pr-2">Kandidat</th>
              <th class="py-2 pr-2">Parti</th>
              <th class="py-2 pr-2">Totale stemmer</th>
              <th class="py-2 pr-2"></th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </section>

    <!-- 4) Tabel/diagram pr. valgsted -->
    <section class="space-y-3">
      <div class="flex gap-2">
        <button class="chip active" data-tab="valgsted-tabel">Tabel pr. valgsted</button>
        <button class="chip" data-tab="valgsted-diagram">Diagram pr. valgsted</button>
      </div>

      <!-- Tabel pr. valgsted -->
      <div id="tab-valgsted-tabel" class="bg-white rounded-2xl shadow-sm border p-4">
        <h2 class="font-medium mb-2">Sammenligning pr. valgsted</h2>
        <div class="overflow-auto">
          <table class="table-sticky w-full text-sm min-w-[640px]" id="psTable">
            <thead id="psThead"></thead>
            <tbody id="psTbody"></tbody>
          </table>
        </div>
        <p class="text-xs text-gray-500 mt-2">Tip: Scroll vandret for at se alle kandidater, hvis der vælges mange.</p>
      </div>

      <!-- Diagram pr. valgsted -->
      <div id="tab-valgsted-diagram" class="bg-white rounded-2xl shadow-sm border p-4 hidden">
        <h2 class="font-medium mb-2">Diagram – stemmer pr. valgsted</h2>
        <div style="height: 420px"><canvas id="chart"></canvas></div>
      </div>
    </section>

    <footer class="pt-2 text-xs text-gray-500">
      Kører 100% i browseren. Dine data forlader ikke din maskine.
    </footer>
  </div>

  <script>
    // ---- Hjælpende fejlvisning ----
    window.addEventListener('error', (e) => {
      const box = document.getElementById('error');
      if (box) box.textContent = 'Fejl i JavaScript: ' + e.message;
    });

    // ---- Regioner & kommuner ----
    const REGIONS = {
      "Region Hovedstaden": ["Albertslund","Allerød","Ballerup","Bornholm","Brøndby","Dragør","Egedal","Fredensborg","Frederiksberg","Frederikssund","Furesø","Gentofte","Gladsaxe","Glostrup","Gribskov","Halsnæs","Herlev","Hillerød","Hvidovre","Høje-Taastrup","Hørsholm","Ishøj","København","Lyngby-Taarbæk","Rudersdal","Rødovre","Tårnby","Vallensbæk"],
      "Region Sjælland": ["Faxe","Greve","Guldborgsund","Holbæk","Kalundborg","Køge","Lejre","Lolland","Næstved","Odsherred","Ringsted","Roskilde","Slagelse","Solrød","Sorø","Stevns","Vordingborg"],
      "Region Syddanmark": ["Assens","Billund","Esbjerg","Fanø","Fredericia","Faaborg-Midtfyn","Haderslev","Kerteminde","Kolding","Langeland","Middelfart","Nordfyns","Nyborg","Odense","Svendborg","Tønder","Varde","Vejen","Vejle","Ærø","Aabenraa","Sønderborg"],
      "Region Midtjylland": ["Favrskov","Hedensted","Herning","Holstebro","Horsens","Ikast-Brande","Lemvig","Norddjurs","Odder","Randers","Ringkøbing-Skjern","Samsø","Silkeborg","Skanderborg","Skive","Struer","Syddjurs","Viborg","Aarhus"],
      "Region Nordjylland": ["Brønderslev","Frederikshavn","Hjørring","Jammerbugt","Læsø","Mariagerfjord","Morsø","Rebild","Thisted","Vesthimmerlands","Aalborg"]
    };

    // ---- STATE ----
    const state = {
      rows: [],              // alle rækker for valgt kommune
      region: "",
      kommune: "",
      selected: new Map(),   // kandidat_id -> { kandidat_id, kandidat_navn, parti }
      chart: null
    };

    // ---- Helpers ----
    const el = (id) => document.getElementById(id);
    const canonical = (s) => (s || "").toString().trim();
    const fmt = (n) => new Intl.NumberFormat("da-DK").format(n);
    const escapeHtml = (s) => (s||"").replace(/[&<>"]/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c]));
    const isListestemmer = (name) => canonical(name).toLowerCase() === "listestemmer";
    const sortCandidates = (a, b) => { // "Listestemmer" sidst
      const aIs = isListestemmer(a.kandidat_navn), bIs = isListestemmer(b.kandidat_navn);
      if (aIs && !bIs) return 1;
      if (!aIs && bIs) return -1;
      return a.kandidat_navn.localeCompare(b.kandidat_navn, "da");
    };

    // ---- INIT ----
    window.addEventListener("DOMContentLoaded", () => {
      initRegionDropdown();
      initTabs();
      bindUI();

      // URL-params (valgfrit)
      const p = new URLSearchParams(location.search);
      const r = p.get("region");
      const k = p.get("kommune");
      if (r && REGIONS[r]) {
        el("regionSelect").value = r;
        populateKommuner(r);
        if (k && REGIONS[r].includes(k)) {
          el("kommuneSelect").value = k;
          loadKommuneData(k);
        }
      }
    });

    // ---- Region/kommune dropdowns ----
    function initRegionDropdown() {
      const rsel = el("regionSelect");
      rsel.innerHTML = `<option value="">Vælg region…</option>` +
        Object.keys(REGIONS).map(r => `<option value="${r}">${r}</option>`).join("");
      rsel.onchange = () => {
        const r = rsel.value;
        state.region = r; state.kommune = "";
        el("kommuneSelect").innerHTML = `<option value="">Vælg region først</option>`;
        el("kommuneSelect").disabled = !r;
        disableCompareControls();
        state.selected.clear(); renderAll();
        if (r) populateKommuner(r);
      };
      el("kommuneSelect").disabled = true;
    }

    function populateKommuner(region) {
      const ksel = el("kommuneSelect");
      const kommuner = REGIONS[region] || [];
      ksel.innerHTML = `<option value="">Vælg kommune…</option>` +
        kommuner.map(k => `<option value="${k}">${k}</option>`).join("");
      ksel.onchange = () => {
        const k = ksel.value;
        state.kommune = k;
        state.selected.clear(); renderAll();
        if (k) {
          const url = new URL(window.location.href);
          url.searchParams.set("region", state.region);
          url.searchParams.set("kommune", k);
          history.replaceState({}, "", url);
          loadKommuneData(k);
        } else {
          state.rows = [];
          disableCompareControls();
          renderAll();
        }
      };
    }

    // ---- UI bind ----
    function bindUI() {
      el("btn-help").onclick = () => alert(
        "CSV-skema:\nkommune, valgsted_id, valgsted_navn, kandidat_id, kandidat_navn, parti, stemmer\n\n"+
        "Filnavn: data/<Kommune>_allepartier.csv (eller data/<Kommune>.csv).\n"+
        "Flow: Region → Kommune → Tilføj kandidater (på tværs af partier).\n"+
        "Bemærk: 'Listestemmer' vises altid sidst."
      );
      el("cmpParti").onchange = populateCompareCandidates;
      el("btn-add").onclick = () => {
        const kid = el("cmpKandidat").value;
        if (!kid) return;
        const k = allCandidates().find(x => x.kandidat_id === kid);
        if (k) state.selected.set(k.kandidat_id, k);
        renderAll();
      };
      el("btn-clear").onclick = () => { state.selected.clear(); renderAll(); };
    }

    function enableCompareControls() {
      el("cmpParti").disabled = false;
      el("cmpKandidat").disabled = false;
      el("btn-add").disabled = false;
    }
    function disableCompareControls() {
      el("cmpParti").disabled = true; el("cmpParti").innerHTML = "";
      el("cmpKandidat").disabled = true; el("cmpKandidat").innerHTML = `<option value="">Vælg kandidat…</option>`;
      el("btn-add").disabled = true;
    }

    // ---- Dataindlæsning ----
    async function loadKommuneData(kommune) {
      el("error").textContent = "";
      const candidates = [
        `data/${kommune}_allepartier.csv`,
        `data/${kommune}.csv`,
      ];
      for (const url of candidates) {
        try {
          const r = await fetch(url, { cache: "no-store" });
          if (!r.ok) throw new Error("HTTP " + r.status);
          const text = await r.text();
          parseCsv(text);
          afterDataLoaded();
          return;
        } catch (err) { /* prøv næste */ }
      }
      el("error").textContent = `Kunne ikke finde data for ${kommune}. Forventede fx /data/${kommune}_allepartier.csv`;
    }

    function parseCsv(text) {
      const res = Papa.parse(text, { header: true, skipEmptyLines: true, transformHeader: h => canonical(h.toLowerCase()) });
      state.rows = res.data.map(r => ({
        kommune: canonical(r.kommune),
        valgsted_id: canonical(r.valgsted_id),
        valgsted_navn: canonical(r.valgsted_navn),
        kandidat_id: canonical(r.kandidat_id || r.kandidat_navn), // fallback hvis ID mangler
        kandidat_navn: canonical(r.kandidat_navn),
        parti: canonical(r.parti),
        stemmer: Number(r.stemmer || 0) || 0,
      }));
    }

    function afterDataLoaded() {
      populateCompareParties();
      populateCompareCandidates();
      enableCompareControls();
      renderAll();
    }

    // ---- Afledte datasæt ----
    function allCandidates() {
      const seen = new Set(), list = [];
      for (const r of state.rows) {
        if (seen.has(r.kandidat_id)) continue;
        seen.add(r.kandidat_id);
        list.push({ kandidat_id: r.kandidat_id, kandidat_navn: r.kandidat_navn, parti: r.parti });
      }
      return list.sort(sortCandidates);
    }

    // Compare controls: udfyldning
    function populateCompareParties() {
      const partier = Array.from(new Set(state.rows.map(r => r.parti))).sort();
      el("cmpParti").innerHTML = partier.map(p => `<option value="${p}">${p}</option>`).join("");
    }
    function populateCompareCandidates() {
      const parti = el("cmpParti").value;
      const list = allCandidates().filter(k => !parti || k.parti === parti);
      el("cmpKandidat").innerHTML =
        `<option value="">Vælg kandidat…</option>` +
        list.map(k => `<option value="${k.kandidat_id}">${escapeHtml(k.kandidat_navn)} (${escapeHtml(k.parti)})</option>`).join("");
    }

    // ---- Rendering ----
    function renderAll() {
      renderSelectedChips();
      renderSummary();
      renderPsTable(getPollingStations(), getSelectedOrdered());
      renderChart();
    }

    function renderSelectedChips() {
      const root = el("selectedChips");
      const sel = getSelectedOrdered();
      root.innerHTML = sel.map(k => `
        <span class="chip">
          ${escapeHtml(k.kandidat_navn)} (${escapeHtml(k.parti)})
          <button class="ml-1" aria-label="Fjern" onclick="removeCandidate('${k.kandidat_id}')">✕</button>
        </span>
      `).join("") || `<span class="text-sm text-gray-500">Ingen kandidater valgt endnu.</span>`;
    }
    window.removeCandidate = (kid) => { state.selected.delete(kid); renderAll(); };

    function getSelected(){ return Array.from(state.selected.values()); }
    function getSelectedOrdered(){ const s = getSelected().slice(); s.sort(sortCandidates); return s; }

    function computeTotalsByCandidate() {
      const totals = new Map();
      for (const r of state.rows) totals.set(r.kandidat_id, (totals.get(r.kandidat_id) || 0) + r.stemmer);
      return totals;
    }

    // Opsummering (samlede stemmer)
    function renderSummary() {
      const totals = computeTotalsByCandidate();
      const tbody = document.querySelector("#summaryTable tbody");
      const selectedList = getSelectedOrdered().map(k => ({ ...k, total: totals.get(k.kandidat_id) || 0 }));
      tbody.innerHTML =
        selectedList.map(s => `<tr class="border-b last:border-0">
          <td class="py-2 pr-2">${escapeHtml(s.kandidat_navn)}</td>
          <td class="py-2 pr-2">${escapeHtml(s.parti)}</td>
          <td class="py-2 pr-2 tabular-nums">${fmt(s.total)}</td>
          <td class="py-2 pr-2"><button class="btn" onclick="removeCandidate('${s.kandidat_id}')">Fjern</button></td>
        </tr>`).join("") ||
        `<tr><td colspan="4" class="py-6 text-center text-gray-500">Vælg kandidater ovenfor.</td></tr>`;
    }

    // Valgsteder
    function getPollingStations() {
      const m = new Map(); // id -> {id, navn, [kandidat_id]:stemmer}
      for (const r of state.rows) {
        if (!m.has(r.valgsted_id)) m.set(r.valgsted_id, { id: r.valgsted_id, navn: r.valgsted_navn });
        const ps = m.get(r.valgsted_id);
        ps[r.kandidat_id] = (ps[r.kandidat_id] || 0) + r.stemmer;
      }
      return Array.from(m.values()).sort((a,b)=> a.navn.localeCompare(b.navn,"da"));
    }

    // Tabel pr. valgsted
    function renderPsTable(psList, sel) {
      const thead = el("psThead");
      const tbody = el("psTbody");
      if (!sel.length) {
        thead.innerHTML = `<tr><th class="text-left py-2 pr-3">Valgsted</th></tr>`;
        tbody.innerHTML = `<tr><td class="py-4 text-center text-gray-500" colspan="1">Vælg mindst én kandidat.</td></tr>`;
        return;
      }
      thead.innerHTML =
        `<tr class="text-left border-b">
           <th class="py-2 pr-3 bg-white">Valgsted</th>
           ${sel.map(s => `<th class="py-2 pr-3">${escapeHtml(s.kandidat_navn)} (${escapeHtml(s.parti)})</th>`).join("")}
           <th class="py-2 pr-3">Total</th>
         </tr>`;
      tbody.innerHTML = psList.map(ps => {
        const cells = sel.map(s => ps[s.kandidat_id] || 0);
        const sum = cells.reduce((a,b)=>a+b,0);
        return `<tr class="border-b last:border-0">
                  <td class="py-2 pr-3 font-medium bg-white">${escapeHtml(ps.navn)}</td>
                  ${cells.map(v => `<td class="py-2 pr-3 tabular-nums">${fmt(v)}</td>`).join("")}
                  <td class="py-2 pr-3 tabular-nums font-medium">${fmt(sum)}</td>
                </tr>`;
      }).join("");
    }

    // Diagram pr. valgsted
    function renderChart() {
      const canvas = document.getElementById("chart");
      const sel = getSelectedOrdered();
      if (!sel.length) { resetChart(); return; }
      const ps = getPollingStations();
      const labels = ps.map(x => x.navn);
      const datasets = sel.map(k => ({
        label: `${k.kandidat_navn} (${k.parti})`,
        data: ps.map(x => x[k.kandidat_id] || 0)
      }));
      if (state.chart) state.chart.destroy();
      state.chart = new Chart(canvas, {
        type: "bar",
        data: { labels, datasets },
        options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true, ticks: { precision: 0 } } } }
      });
    }
    function resetChart(){ if (state.chart) { state.chart.destroy(); state.chart = null; } }

    // Tabs
    function initTabs() {
      for (const b of document.querySelectorAll("[data-tab]")) {
        b.onclick = () => {
          document.querySelectorAll("[data-tab]").forEach(x=>x.classList.remove("active"));
          b.classList.add("active");
          const t = b.getAttribute("data-tab");
          document.getElementById("tab-valgsted-tabel").classList.toggle("hidden", t !== "valgsted-tabel");
          document.getElementById("tab-valgsted-diagram").classList.toggle("hidden", t !== "valgsted-diagram");
        };
      }
    }
  </script>
</body>
</html>
