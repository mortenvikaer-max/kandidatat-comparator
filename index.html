<!doctype html>
<html lang="da">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>KV – Kandidater & partier</title>

  <!-- Tailwind CSS (CDN) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- PapaParse -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

  <style>
    .chip { @apply inline-flex items-center gap-2 px-3 py-1 rounded-2xl border text-sm cursor-pointer select-none; }
    .chip.active { @apply bg-gray-900 text-white border-gray-900; }
    .card { @apply bg-white rounded-2xl shadow-sm border; }
    .btn  { @apply inline-flex items-center gap-2 rounded-xl border px-3 py-2; }
    .btn:disabled { @apply opacity-50 cursor-not-allowed; }
    .table-sticky thead th:first-child, .table-sticky tbody td:first-child { position: sticky; left: 0; background: white; }
    .tabbox { @apply flex-1 rounded-xl border px-4 py-3 text-center cursor-pointer select-none; }
    .tabbox.active { @apply border-gray-900 bg-gray-900 text-white; }
  </style>
</head>

<body class="bg-gray-50 text-gray-900">
  <!-- HERO -->
  <section class="bg-gradient-to-b from-gray-900 to-gray-800 text-white">
    <div class="mx-auto max-w-6xl px-4 py-10">
      <div class="text-3xl md:text-4xl font-extrabold tracking-tight">Valgresultater – Kommunalvalg 2021</div>
      <div class="mt-2 text-white/80">Vælg en kommune og få overblik over partier og kandidater.</div>

      <div class="mt-6 grid grid-cols-1 md:grid-cols-3 gap-3">
        <div>
          <label class="text-sm text-white/80">Region</label>
          <select id="regionSelect" class="w-full mt-1 rounded-xl border p-2 text-gray-900"></select>
        </div>
        <div class="md:col-span-2">
          <label class="text-sm text-white/80">Kommune</label>
          <select id="kommuneSelect" class="w-full mt-1 rounded-xl border p-2 text-gray-900" disabled></select>
        </div>
      </div>

      <div id="error" class="mt-3 text-sm text-red-200"></div>
    </div>
  </section>

  <!-- HOVEDINDHOLD -->
  <main class="mx-auto max-w-6xl p-4 space-y-6">

    <!-- PARTI-OVERSIGT -->
    <section>
      <div class="flex items-center justify-between mb-3">
        <h2 class="text-xl font-semibold">Partier og kandidater</h2>
        <div id="kommunetitel" class="text-gray-500"></div>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
        <aside class="space-y-2 md:col-span-1" id="partyList"></aside>

        <section class="md:col-span-2 card p-4 space-y-3" id="partyDetail">
          <div id="partyDetailHeader" class="text-gray-500 text-sm">Vælg et parti i venstre panel for at se kandidater.</div>
          <div id="candidateList" class="grid grid-cols-1 md:grid-cols-2 gap-2"></div>
        </section>
      </div>
    </section>

    <!-- SAMMENLIGNING (nu med total pr. kandidat) -->
    <section id="compareSection" class="card p-4 space-y-3 hidden">
      <div class="flex items-center justify-between">
        <h2 class="font-medium">Sammenligning af kandidater</h2>
        <button id="btnClearAll" class="btn">Nulstil alle valgte kandidater</button>
      </div>
      <div id="selectedList" class="space-y-2"></div>
    </section>

    <!-- TABEL/DIAGRAM — med tydelig boks omkring tabs -->
    <section id="tabsCard" class="card p-4 space-y-4 hidden">
      <div class="rounded-2xl border bg-white p-2 shadow-sm flex gap-2">
        <button class="tabbox active" data-tab="valgsted-tabel">Tabel pr. valgsted</button>
        <button class="tabbox" data-tab="valgsted-diagram">Diagram pr. valgsted</button>
      </div>

      <div id="tab-valgsted-tabel">
        <div class="overflow-auto">
          <table class="table-sticky w-full text-sm min-w-[640px]" id="psTable">
            <thead id="psThead"></thead>
            <tbody id="psTbody"></tbody>
            <tfoot id="psTFoot"></tfoot>
          </table>
        </div>
      </div>

      <div id="tab-valgsted-diagram" class="hidden">
        <div style="height: 420px"><canvas id="chart"></canvas></div>
      </div>
    </section>
  </main>

  <script>
    // ——— Fejlvisning ———
    window.addEventListener('error', (e) => {
      const box = document.getElementById('error');
      if (box) box.textContent = 'Fejl i JavaScript: ' + e.message;
    });

    // ——— Regioner & kommuner ———
    const REGIONS = {
      "Region Hovedstaden": ["Albertslund","Allerød","Ballerup","Bornholm","Brøndby","Dragør","Egedal","Fredensborg","Frederiksberg","Frederikssund","Furesø","Gentofte","Gladsaxe","Glostrup","Gribskov","Halsnæs","Herlev","Hillerød","Hvidovre","Høje-Taastrup","Hørsholm","Ishøj","København","Lyngby-Taarbæk","Rudersdal","Rødovre","Tårnby","Vallensbæk"],
      "Region Sjælland": ["Faxe","Greve","Guldborgsund","Holbæk","Kalundborg","Køge","Lejre","Lolland","Næstved","Odsherred","Ringsted","Roskilde","Slagelse","Solrød","Sorø","Stevns","Vordingborg"],
      "Region Syddanmark": ["Assens","Billund","Esbjerg","Fanø","Fredericia","Faaborg-Midtfyn","Haderslev","Kerteminde","Kolding","Langeland","Middelfart","Nordfyns","Nyborg","Odense","Svendborg","Tønder","Varde","Vejen","Vejle","Ærø","Aabenraa","Sønderborg"],
      "Region Midtjylland": ["Favrskov","Hedensted","Herning","Holstebro","Horsens","Ikast-Brande","Lemvig","Norddjurs","Odder","Randers","Ringkøbing-Skjern","Samsø","Silkeborg","Skanderborg","Skive","Struer","Syddjurs","Viborg","Aarhus"],
      "Region Nordjylland": ["Brønderslev","Frederikshavn","Hjørring","Jammerbugt","Læsø","Mariagerfjord","Morsø","Rebild","Thisted","Vesthimmerlands","Aalborg"]
    };

    // ——— PARTIFARVER (efter bogstav) ———
    const PARTY_COLORS = {
      "A": "#e03a3e","B": "#712082","C": "#2e7d32","D": "#0f766e","F": "#e5003d",
      "I": "#00a0e3","O": "#0044aa","V": "#1b5eaa","Ø": "#c8102e","Å": "#3aaa35",
      "Q": "#ff4fa3","K": "#ff9800","Æ": "#666666"
    };
    const DEFAULT_BADGE_BG = "#e5e7eb";
    const DEFAULT_BADGE_FG = "#111827";

    // ——— STATE ———
    const state = {
      rows: [],
      region: "", kommune: "",
      activeParty: "",
      selected: new Map(),
      chart: null
    };

    // ——— Helpers ———
    const el = (id) => document.getElementById(id);
    const fmt = (n) => new Intl.NumberFormat("da-DK").format(n);
    const canon = (s) => (s||"").toString().trim();
    const escapeHtml = (s) => (s||"").replace(/[&<>"]/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c]));
    const isListestemmer = (name) => canon(name).toLowerCase() === "listestemmer";
    const sortKandidaterAlpha = (a,b) => {
      const al = isListestemmer(a.kandidat_navn), bl = isListestemmer(b.kandidat_navn);
      if (al && !bl) return 1;
      if (!al && bl) return -1;
      return a.kandidat_navn.localeCompare(b.kandidat_navn, "da");
    };
    const partiLetter = (kid) => {
      const p = (kid||"").split("_")[0];
      return p ? p.toUpperCase() : "•";
    };
    function badge(letter){
      const bg = PARTY_COLORS[letter] || DEFAULT_BADGE_BG;
      const isDefault = !(letter in PARTY_COLORS);
      const fg = isDefault ? DEFAULT_BADGE_FG : "#ffffff";
      return {bg, fg, style:`background-color:${bg}; color:${fg}; border-color:${bg}`};
    }

    // ——— INIT ———
    window.addEventListener("DOMContentLoaded", () => {
      initRegionDropdown();
      initTabs();
      const p = new URLSearchParams(location.search);
      const r = p.get("region");
      const k = p.get("kommune");
      if (r && REGIONS[r]) {
        el("regionSelect").value = r;
        populateKommuner(r);
        if (k && REGIONS[r].includes(k)) {
          el("kommuneSelect").value = k;
          loadKommuneData(k);
        }
      }
      el("btnClearAll").onclick = () => { state.selected.clear(); renderAll(); };
    });

    // ——— Dropdowns ———
    function initRegionDropdown(){
      const rsel = el("regionSelect");
      rsel.innerHTML = `<option value="">Vælg region…</option>` +
        Object.keys(REGIONS).map(r=>`<option value="${r}">${r}</option>`).join("");
      rsel.onchange = ()=>{
        const r = rsel.value;
        state.region = r; state.kommune=""; state.activeParty="";
        el("kommuneSelect").disabled = !r;
        el("kommuneSelect").innerHTML = `<option value="">Vælg kommune…</option>`;
        if (r) populateKommuner(r);
        clearAll();
      };
      el("kommuneSelect").disabled = true;
    }
    function populateKommuner(region){
      const ksel = el("kommuneSelect");
      const kommuner = REGIONS[region]||[];
      ksel.innerHTML = `<option value="">Vælg kommune…</option>`+
        kommuner.map(k=>`<option value="${k}">${k}</option>`).join("");
      ksel.onchange = ()=>{
        const k = ksel.value;
        state.kommune = k; state.activeParty="";
        clearAll();
        if (k){
          const u = new URL(location.href); u.searchParams.set("region", state.region); u.searchParams.set("kommune", k);
          history.replaceState({}, "", u);
          loadKommuneData(k);
        }
      };
    }

    function clearAll(){
      state.rows = []; state.selected.clear();
      el("partyList").innerHTML = "";
      el("partyDetailHeader").textContent = "Vælg et parti i venstre panel for at se kandidater.";
      el("candidateList").innerHTML = "";
      el("kommunetitel").textContent = "";
      renderAll();
    }

    // ——— Data ———
    async function loadKommuneData(k){
      el("error").textContent = "";
      el("kommunetitel").textContent = k ? `(${k})` : "";
      const safe = encodeURIComponent(k);
      const candidates = [`data/${safe}_allepartier.csv`, `data/${safe}.csv`];
      for (const url of candidates){
        try{
          const r = await fetch(url, {cache:"no-store"});
          if (!r.ok) throw new Error("HTTP "+r.status);
          const text = await r.text();
          parseCsv(text);
          afterDataLoaded();
          return;
        }catch(e){}
      }
      el("error").textContent = `Kunne ikke finde data for ${k}. Forventede fx /data/${k}_allepartier.csv`;
    }
    function parseCsv(text){
      const res = Papa.parse(text, {header:true, skipEmptyLines:true, transformHeader:h=>canon(h.toLowerCase())});
      state.rows = res.data.map(r=>({
        kommune: canon(r.kommune),
        valgsted_id: canon(r.valgsted_id),
        valgsted_navn: canon(r.valgsted_navn),
        kandidat_id: canon(r.kandidat_id || r.kandidat_navn),
        kandidat_navn: canon(r.kandidat_navn),
        parti: canon(r.parti),
        stemmer: Number(r.stemmer||0)||0
      }));
    }
    function afterDataLoaded(){
      renderPartyOverview();
      renderAll();
    }

    // ——— Parti-oversigt ———
    function getPartyStats(){
      const byParti = new Map();
      for (const r of state.rows){
        if (!byParti.has(r.parti)) byParti.set(r.parti, []);
        byParti.get(r.parti).push(r);
      }
      const res = [];
      for (const [parti, rows] of byParti.entries()){
        const candMap = new Map();
        for (const r of rows){
          if (!candMap.has(r.kandidat_id)){
            candMap.set(r.kandidat_id, {kandidat_id:r.kandidat_id, kandidat_navn:r.kandidat_navn, parti:r.parti, total:0});
          }
          candMap.get(r.kandidat_id).total += r.stemmer;
        }
        const kandidater = Array.from(candMap.values()).sort(sortKandidaterAlpha);
        res.push({
          parti,
          letter: partiLetter(kandidater[0]?.kandidat_id || ""),
          kandidatAntal: kandidater.filter(k=>!isListestemmer(k.kandidat_navn)).length,
          kandidater
        });
      }
      res.sort((a,b)=> a.letter.localeCompare(b.letter, "da"));
      return res;
    }

    function renderPartyOverview(){
      const host = el("partyList");
      host.innerHTML = "";
      const stats = getPartyStats();
      if (!stats.length){
        host.innerHTML = `<div class="text-sm text-gray-500">Vælg en kommune for at se partier.</div>`;
        return;
      }
      for (const p of stats){
        const { style } = badge(p.letter);
        const div = document.createElement("div");
        div.className = `flex items-center justify-between rounded-xl border px-3 py-2 cursor-pointer hover:bg-gray-100 transition ${
          state.activeParty === p.parti ? "bg-gray-100 border-gray-400" : "border-gray-200"
        }`;
        div.innerHTML = `
          <div class="flex items-center gap-3">
            <div class="h-9 w-9 rounded-full border flex items-center justify-center font-semibold" style="${style}">
              ${escapeHtml(p.letter)}
            </div>
            <div>
              <div class="font-medium">${escapeHtml(p.parti)}</div>
              <div class="text-xs text-gray-500">${p.kandidatAntal} kandidater</div>
            </div>
          </div>`;
        div.addEventListener("click", ()=>{
          state.activeParty = p.parti;
          renderPartyOverview();
          renderPartyDetail(p.parti);
        });
        host.appendChild(div);
      }
      if (!state.activeParty && stats.length){
        state.activeParty = stats[0].parti;
        renderPartyOverview();
        renderPartyDetail(state.activeParty);
      }
    }

    // ——— Højre panel: kandidater ———
    function renderPartyDetail(parti){
      const header = el("partyDetailHeader");
      const list = el("candidateList");
      list.innerHTML = "";
      if (!parti){
        header.textContent = "Vælg et parti i venstre panel for at se kandidater.";
        return;
      }
      header.textContent = parti;

      const kandidaterAll = getPartyStats().find(x => x.parti === parti)?.kandidater || [];
      const sorted = kandidaterAll.slice().sort(sortKandidaterAlpha);

      for (const k of sorted){
        const row = document.createElement("div");
        row.className = `rounded-xl border px-3 py-2 flex items-center justify-between`;
        row.innerHTML = `
          <div>
            <div class="font-medium">${escapeHtml(k.kandidat_navn)}</div>
            <div class="text-xs text-gray-500">${escapeHtml(k.parti)} · ${fmt(k.total)} stemmer i alt</div>
          </div>
          <button class="btn" data-add="${k.kandidat_id}">Tilføj</button>
        `;
        row.querySelector("button[data-add]").addEventListener("click", ()=>{
          state.selected.set(k.kandidat_id, {kandidat_id:k.kandidat_id, kandidat_navn:k.kandidat_navn, parti:k.parti});
          renderAll();
        });
        list.appendChild(row);
      }
    }

    // ——— Synlighed + samlet render ———
    function renderAll(){
      renderSelected();
      renderPsTable(getPollingStations(), getSelectedOrdered());
      renderChart();
      const hasSel = getSelected().length > 0;
      el("compareSection").classList.toggle("hidden", !hasSel);
      el("tabsCard").classList.toggle("hidden", !hasSel);
    }

    // ——— Valgte kandidater (med badge + total) ———
    function computeTotalsByCandidate(){
      const totals = new Map();
      for (const r of state.rows) totals.set(r.kandidat_id, (totals.get(r.kandidat_id)||0) + r.stemmer);
      return totals;
    }

    function renderSelected(){
      const root = el("selectedList");
      const totals = computeTotalsByCandidate();
      const sel = getSelectedOrdered();
      root.innerHTML = sel.map(k => {
        const letter = partiLetter(k.kandidat_id);
        const { style } = badge(letter);
        const total = totals.get(k.kandidat_id) || 0;
        return `
          <div class="rounded-xl border p-3 flex items-center justify-between">
            <div class="flex items-center gap-3">
              <div class="h-7 w-7 rounded-full border flex items-center justify-center text-sm font-semibold" style="${style}">
                ${escapeHtml(letter)}
              </div>
              <div class="font-medium">${escapeHtml(k.kandidat_navn)} <span class="text-gray-500">(${escapeHtml(k.parti)})</span></div>
            </div>
            <div class="flex items-center gap-3">
              <div class="tabular-nums font-medium">${fmt(total)}</div>
              <button class="btn" onclick="removeCandidate('${k.kandidat_id}')">Fjern</button>
            </div>
          </div>
        `;
      }).join("") || `<div class="text-sm text-gray-500">Ingen kandidater valgt endnu.</div>`;
      el("btnClearAll").disabled = sel.length === 0;
    }

    window.removeCandidate = (kid)=>{ state.selected.delete(kid); renderAll(); };
    function getSelected(){ return Array.from(state.selected.values()); }
    function getSelectedOrdered(){ const s = getSelected().slice(); s.sort(sortKandidaterAlpha); return s; }

    // ——— Valgstedstabel & diagram ———
    function getPollingStations(){
      const m = new Map();
      for (const r of state.rows){
        if (!m.has(r.valgsted_id)) m.set(r.valgsted_id, { id:r.valgsted_id, navn:r.valgsted_navn });
        const ps = m.get(r.valgsted_id);
        ps[r.kandidat_id] = (ps[r.kandidat_id]||0) + r.stemmer;
      }
      return Array.from(m.values()).sort((a,b)=> a.navn.localeCompare(b.navn,"da"));
    }

    function renderPsTable(psList, sel){
      const thead = el("psThead"), tbody = el("psTbody"), tfoot = el("psTFoot");
      if (!sel.length){
        thead.innerHTML = `<tr><th class="text-left py-2 pr-3">Valgsted</th></tr>`;
        tbody.innerHTML = ``; tfoot.innerHTML = ``; return;
      }
      // header med badges
      const headerCols = sel.map(s=>{
        const letter = partiLetter(s.kandidat_id);
        const { style } = badge(letter);
        return `
          <th class="py-2 pr-3">
            <div class="flex items-center gap-2">
              <span class="h-6 w-6 rounded-full border inline-flex items-center justify-center text-xs font-semibold" style="${style}">
                ${escapeHtml(letter)}
              </span>
              <span>${escapeHtml(s.kandidat_navn)} (${escapeHtml(s.parti)})</span>
            </div>
          </th>`;
      }).join("");

      thead.innerHTML = `
        <tr class="text-left border-b">
          <th class="py-2 pr-3 bg-white">Valgsted</th>
          ${headerCols}
        </tr>`;

      tbody.innerHTML = psList.map(ps=>{
        const cells = sel.map(s=> ps[s.kandidat_id]||0 );
        return `<tr class="border-b last:border-0">
          <td class="py-2 pr-3 font-medium bg-white">${escapeHtml(ps.navn)}</td>
          ${cells.map(v=>`<td class="py-2 pr-3 tabular-nums">${fmt(v)}</td>`).join("")}
        </tr>`;
      }).join("");

      // kommunetotal i bund
      const totals = computeTotalsByCandidate();
      const foot = sel.map(s=> `<td class="py-2 pr-3 tabular-nums font-medium">${fmt(totals.get(s.kandidat_id)||0)}</td>`).join("");
      tfoot.innerHTML = `<tr class="border-t"><th class="py-2 pr-3 text-left bg-white">Kommunetotal</th>${foot}</tr>`;
    }

    function renderChart(){
      const canvas = document.getElementById("chart");
      const sel = getSelectedOrdered();
      if (!sel.length){ resetChart(); return; }
      const ps = getPollingStations();
      const labels = ps.map(x=>x.navn);
      const datasets = sel.map(k=>({ label:`${k.kandidat_navn} (${k.parti})`, data: ps.map(x=> x[k.kandidat_id]||0) }));
      if (state.chart) state.chart.destroy();
      state.chart = new Chart(canvas, {
        type:"bar",
        data:{ labels, datasets },
        options:{ responsive:true, maintainAspectRatio:false, scales:{ y:{ beginAtZero:true, ticks:{ precision:0 } } } }
      });
    }
    function resetChart(){ if (state.chart){ state.chart.destroy(); state.chart=null; } }

    // ——— Tabs ———
    function initTabs(){
      for (const b of document.querySelectorAll("[data-tab]")){
        b.onclick = ()=>{
          document.querySelectorAll(".tabbox").forEach(x=>x.classList.remove("active"));
          b.classList.add("active");
          const t = b.getAttribute("data-tab");
          document.getElementById("tab-valgsted-tabel").classList.toggle("hidden", t!=="valgsted-tabel");
          document.getElementById("tab-valgsted-diagram").classList.toggle("hidden", t!=="valgsted-diagram");
        };
      }
    }
  </script>
</body>
</html>
