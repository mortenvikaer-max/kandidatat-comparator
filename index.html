<!doctype html>
<html lang="da">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Valgbar – Kandidater & partier</title>

  <!-- Tailwind CSS (CDN) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- PapaParse -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

  <style>
    :root{
      --vb-navy:#234a5a;
      --vb-navy-2:#1b3d4d;
    }
    .vb-card{ background:#fff; border:1px solid #e5e7eb; border-radius:16px; box-shadow:0 1px 2px rgba(16,24,40,.04); }
    .vb-btn{ display:inline-flex; align-items:center; gap:.5rem; padding:.5rem .75rem; border:1px solid #e5e7eb; border-radius:12px; background:#fff; }
    .vb-btn:disabled{ opacity:.5; cursor:not-allowed; }
    .vb-tabbox{ flex:1 1 auto; border:1px solid #e5e7eb; border-radius:12px; padding:.6rem 1rem; text-align:center; cursor:pointer; user-select:none; background:#fff; }
    .vb-tabbox.active{ background:#111827; color:#fff; border-color:#111827; }

    .vb-combo-btn{ width:100%; border:1px solid #e5e7eb; border-radius:12px; padding:.5rem .75rem; background:#fff;
                   display:flex; align-items:center; justify-content:space-between; }
    .vb-combo-btn[disabled]{ opacity:.6; cursor:not-allowed; }
    .vb-combo-label{ display:flex; align-items:center; gap:.75rem; min-width:0; }
    .vb-badge{ height:28px; width:28px; display:inline-flex; align-items:center; justify-content:center;
               border-radius:9999px; border:1px solid transparent; font-weight:600; font-size:.9rem; }

    .vb-menu{ position:absolute; z-index:50; margin-top:.25rem; width:100%;
              max-height:18rem; overflow:auto; background:#fff; border:1px solid #e5e7eb;
              border-radius:12px; box-shadow:0 8px 24px rgba(0,0,0,.08); }
    .vb-option{ display:flex; align-items:center; gap:.75rem; padding:.5rem .75rem; cursor:pointer; }
    .vb-option:hover, .vb-option[aria-selected="true"]{ background:#f3f4f6; }

    .table-sticky thead th:first-child, .table-sticky tbody td:first-child, .table-sticky tfoot th:first-child{
      position:sticky; left:0; background:#fff;
    }
    .vb-hero{ background:linear-gradient(180deg, var(--vb-navy) 0%, var(--vb-navy-2) 100%); color:#fff; }
  </style>
</head>

<body class="bg-gray-50 text-gray-900">

<!-- HEADER -->
<header class="vb-hero">
  <div class="mx-auto max-w-6xl px-4 py-6 flex items-center gap-4">
    <a href="/" class="flex items-center gap-3">
      <!-- Større logo -->
      <img src="Valgbar-transparent.png" alt="Valgbar" class="h-16 md:h-20 w-auto"
           onerror="this.style.display='none';document.getElementById('vbTitle').classList.remove('hidden');" />
      <!-- Tydelig titel, lidt større end underteksten -->
      <span id="vbTitle" class="text-2xl md:text-3xl font-bold tracking-tight">Valgbar</span>
    </a>
  </div>

  <div class="mx-auto max-w-6xl px-4 pb-8">
    <!-- Gør underteksten en smule mindre end titlen -->
    <div class="text-white/80 text-base md:text-lg">
      Vælg en kommune og få overblik over partier og kandidater.
    </div>

    <div class="mt-6 grid grid-cols-1 md:grid-cols-3 gap-3">
      <div>
        <label class="text-sm text-white/80">Region</label>
        <select id="regionSelect" class="w-full mt-1 rounded-xl border p-2 text-gray-900"></select>
      </div>
      <div class="md:col-span-2">
        <label class="text-sm text-white/80">Kommune</label>
        <select id="kommuneSelect" class="w-full mt-1 rounded-xl border p-2 text-gray-900" disabled></select>
      </div>
    </div>

    <div id="error" class="mt-3 text-sm text-red-200"></div>
  </div>
</header>

  <!-- INDHOLD -->
  <main class="mx-auto max-w-6xl p-4 space-y-6">
    <section>
      <div class="flex items-center justify-between mb-3">
        <h2 class="text-xl font-semibold">Partier og kandidater</h2>
        <div id="kommunetitel" class="text-gray-500"></div>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
        <aside class="md:col-span-1 vb-card p-4 space-y-2">
          <label class="text-sm font-medium">Vælg parti</label>
          <div id="partyCombo" class="relative">
            <button id="partyButton" type="button" class="vb-combo-btn" aria-haspopup="listbox" aria-expanded="false" disabled>
              <span id="partyButtonContent" class="vb-combo-label">
                <span class="vb-badge" style="background:#e5e7eb; color:#111827; border-color:#e5e7eb"> </span>
                <span class="truncate text-gray-500">Vælg kommune først…</span>
              </span>
              <svg class="h-4 w-4 opacity-60" viewBox="0 0 20 20" fill="currentColor"><path d="M5.23 7.21a.75.75 0 011.06.02L10 11.104l3.71-3.873a.75.75 0 011.08 1.04l-4.24 4.43a.75.75 0 01-1.08 0l-4.24-4.43a.75.75 0 01.02-1.06z"/></svg>
            </button>
            <div id="partyMenu" class="vb-menu hidden" role="listbox" tabindex="-1" aria-labelledby="partyButton"></div>
          </div>
        </aside>

        <section class="md:col-span-2 vb-card p-4 space-y-3" id="partyDetail">
          <div id="partyDetailHeader" class="text-gray-500 text-sm">Vælg et parti i drop-down menuen.</div>
          <div id="candidateList" class="grid grid-cols-1 md:grid-cols-2 gap-2"></div>
        </section>
      </div>
    </section>

    <section id="compareSection" class="vb-card p-4 space-y-3 hidden">
      <div class="flex items-center justify-between">
        <h2 class="font-medium">Sammenligning af kandidater</h2>
        <button id="btnClearAll" class="vb-btn">Nulstil alle valgte kandidater</button>
      </div>
      <div id="selectedList" class="space-y-2"></div>
    </section>

    <section id="tabsCard" class="vb-card p-4 space-y-4 hidden">
      <div class="rounded-2xl border bg-white p-2 shadow-sm flex gap-2">
        <button class="vb-tabbox active" data-tab="valgsted-tabel">Tabel pr. valgsted</button>
        <button class="vb-tabbox" data-tab="valgsted-diagram">Diagram pr. valgsted</button>
      </div>

      <div id="tab-valgsted-tabel">
        <div class="overflow-auto">
          <table class="table-sticky w-full text-sm min-w-[640px]" id="psTable">
            <thead id="psThead"></thead>
            <tbody id="psTbody"></tbody>
            <tfoot id="psTFoot"></tfoot>
          </table>
        </div>
      </div>

      <div id="tab-valgsted-diagram" class="hidden">
        <div style="height: 420px"><canvas id="chart"></canvas></div>
      </div>
    </section>
  </main>

  <!--  JS  -->
  <script>
    /* Fast data-sti */
    const BASE_PATH = 'data/kv/2021/';

    /* Regioner & kommuner */
    const REGIONS = {
      "Region Hovedstaden": ["Albertslund","Allerød","Ballerup","Bornholm","Brøndby","Dragør","Egedal","Fredensborg","Frederiksberg","Frederikssund","Furesø","Gentofte","Gladsaxe","Glostrup","Gribskov","Halsnæs","Herlev","Hillerød","Hvidovre","Høje-Taastrup","Hørsholm","Ishøj","København","Lyngby-Taarbæk","Rudersdal","Rødovre","Tårnby","Vallensbæk"],
      "Region Sjælland": ["Faxe","Greve","Guldborgsund","Holbæk","Kalundborg","Køge","Lejre","Lolland","Næstved","Odsherred","Ringsted","Roskilde","Slagelse","Solrød","Sorø","Stevns","Vordingborg"],
      "Region Syddanmark": ["Assens","Billund","Esbjerg","Fanø","Fredericia","Faaborg-Midtfyn","Haderslev","Kerteminde","Kolding","Langeland","Middelfart","Nordfyns","Nyborg","Odense","Svendborg","Tønder","Varde","Vejen","Vejle","Ærø","Aabenraa","Sønderborg"],
      "Region Midtjylland": ["Favrskov","Hedensted","Herning","Holstebro","Horsens","Ikast-Brande","Lemvig","Norddjurs","Odder","Randers","Ringkøbing-Skjern","Samsø","Silkeborg","Skanderborg","Skive","Struer","Syddjurs","Viborg","Aarhus"],
      "Region Nordjylland": ["Brønderslev","Frederikshavn","Hjørring","Jammerbugt","Læsø","Mariagerfjord","Morsø","Rebild","Thisted","Vesthimmerlands","Aalborg"]
    };

    /* Partifarver */
    const PARTY_COLORS = {
      "A":"#e03a3e","B":"#712082","C":"#2e7d32","D":"#0f766e","F":"#e5003d",
      "I":"#00a0e3","O":"#0044aa","V":"#1b5eaa","Ø":"#c8102e","Å":"#3aaa35",
      "Q":"#ff4fa3","K":"#ff9800","Æ":"#666666"
    };
    const DEFAULT_BADGE_BG = "#e5e7eb";
    const DEFAULT_BADGE_FG = "#111827";

    /* State & helpers */
    const state = { rows:[], region:"", kommune:"", activeParty:"", selected:new Map(), chart:null };
    const el = id => document.getElementById(id);
    const fmt = n => new Intl.NumberFormat("da-DK").format(n);
    const canon = s => (s||"").toString().trim();
    const escapeHtml = s => (s||"").replace(/[&<>"]/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c]));
    const isListestemmer = name => canon(name).toLowerCase()==="listestemmer";
    const sortKandidaterAlpha = (a,b)=>{
      const al=isListestemmer(a.kandidat_navn), bl=isListestemmer(b.kandidat_navn);
      if(al&&!bl) return 1; if(!al&&bl) return -1;
      return a.kandidat_navn.localeCompare(b.kandidat_navn,"da");
    };

    /* Bogstav-detektor fra rækker (kan være null) */
    function detectPartyLetterFromRows(rowsForParti){
      for(const r of rowsForParti){
        const m = (r.kandidat_id||"").trim().toUpperCase().match(/^([A-ZÆØÅ])/);
        const letter = m?.[1] || null;
        if(letter && PARTY_COLORS[letter]) return letter;
      }
      return null;
    }
    function badge(letter){
      const bg = letter ? PARTY_COLORS[letter] : DEFAULT_BADGE_BG;
      const fg = letter ? "#fff" : DEFAULT_BADGE_FG;
      return { style:`background-color:${bg};color:${fg};border-color:${bg}`, text: (letter||" ") };
    }

    /* Init */
    window.addEventListener("DOMContentLoaded", ()=>{
      initRegionDropdown(); initTabs();
      const p=new URLSearchParams(location.search), r=p.get("region"), k=p.get("kommune");
      if(r && REGIONS[r]){ el("regionSelect").value=r; populateKommuner(r);
        if(k && REGIONS[r].includes(k)){ el("kommuneSelect").value=k; loadKommuneData(k); } }
      el("btnClearAll").onclick=()=>{ state.selected.clear(); renderAll(); };

      document.addEventListener('click',(e)=>{ const box=el('partyCombo'); if(box && !box.contains(e.target)) closePartyMenu(); });
      document.addEventListener('keydown',(e)=>{ if(e.key==='Escape') closePartyMenu(); });
    });

    /* Region/Kommune */
    function initRegionDropdown(){
      const rsel=el("regionSelect");
      rsel.innerHTML=`<option value="">Vælg region…</option>`+Object.keys(REGIONS).map(r=>`<option value="${r}">${r}</option>`).join("");
      rsel.onchange=()=>{
        const r=rsel.value; state.region=r; state.kommune=""; state.activeParty="";
        el("kommuneSelect").disabled=!r;
        el("kommuneSelect").innerHTML=`<option value="">Vælg kommune…</option>`;
        if(r) populateKommuner(r); clearAll();
      };
      el("kommuneSelect").disabled=true;
    }
    function populateKommuner(region){
      const ksel=el("kommuneSelect"), kommuner=REGIONS[region]||[];
      ksel.innerHTML=`<option value="">Vælg kommune…</option>`+kommuner.map(k=>`<option value="${k}">${k}</option>`).join("");
      ksel.onchange=()=>{
        const k=ksel.value; state.kommune=k; state.activeParty=""; clearAll();
        if(k){ const u=new URL(location.href); u.searchParams.set("region",state.region); u.searchParams.set("kommune",k);
          history.replaceState({}, "", u); loadKommuneData(k); }
      };
    }
    function clearAll(){
      state.rows=[]; state.selected.clear();
      const btn=el("partyButton"), btnc=el("partyButtonContent"); btn.disabled=true; btn.setAttribute('aria-expanded','false');
      btnc.innerHTML=`<span class="vb-badge" style="background:#e5e7eb;color:#111827;border-color:#e5e7eb"> </span><span class="truncate text-gray-500">Vælg kommune først…</span>`;
      el("partyMenu").innerHTML="";
      el("partyDetailHeader").textContent="Vælg et parti i drop-down menuen.";
      el("candidateList").innerHTML=""; el("kommunetitel").textContent=""; renderAll();
    }

    /* Data-indlæsning */
    async function loadKommuneData(k){
      el("error").textContent=""; el("kommunetitel").textContent=k?`(${k})`:"";
      const safe=encodeURIComponent(k);
      const candidates=[`${BASE_PATH}${safe}_allepartier.csv`, `${BASE_PATH}${safe}.csv`];
      for(const url of candidates){
        try{
          const r=await fetch(url,{cache:"no-store"});
          if(!r.ok) throw new Error();
          const text=await r.text();
          parseCsv(text);
          afterDataLoaded();
          return;
        }catch(e){}
      }
      el("error").textContent=`Kunne ikke finde data for ${k}. Forventede fx /${BASE_PATH}${k}_allepartier.csv`;
    }
    function parseCsv(text){
      const res=Papa.parse(text,{header:true,skipEmptyLines:true,transformHeader:h=>canon(h.toLowerCase())});
      state.rows=res.data.map(r=>({
        kommune:canon(r.kommune), valgsted_id:canon(r.valgsted_id), valgsted_navn:canon(r.valgsted_navn),
        kandidat_id:canon(r.kandidat_id||r.kandidat_navn), kandidat_navn:canon(r.kandidat_navn),
        parti:canon(r.parti), stemmer:Number(r.stemmer||0)||0
      }));
    }
    function afterDataLoaded(){ state.activeParty=""; renderPartyCombobox(); renderAll(); }

    /* Parti-stats (inkl. bogstav & kandidater) */
    function getPartyStats(){
      const byParti=new Map();
      for(const r of state.rows){
        if(!byParti.has(r.parti)) byParti.set(r.parti,[]);
        byParti.get(r.parti).push(r);
      }
      const res=[];
      for(const [parti,rows] of byParti.entries()){
        const map=new Map();
        for(const r of rows){
          if(!map.has(r.kandidat_id)) map.set(r.kandidat_id,{kandidat_id:r.kandidat_id,kandidat_navn:r.kandidat_navn,parti:r.parti,total:0});
          map.get(r.kandidat_id).total+=r.stemmer;
        }
        const kandidater=Array.from(map.values()).sort(sortKandidaterAlpha);
        const letter = detectPartyLetterFromRows(rows); // kan være null
        res.push({
          parti,
          letter,
          hasLetter: !!letter,
          kandidatAntal: kandidater.filter(k=>!isListestemmer(k.kandidat_navn)).length,
          kandidater
        });
      }
      // Sortér: først med bogstav (A..Å), derefter partier uden bogstav (navn)
      res.sort((a,b)=>{
        if(a.hasLetter!==b.hasLetter) return a.hasLetter ? -1 : 1;
        if(a.hasLetter && b.hasLetter) return a.letter.localeCompare(b.letter,"da");
        return a.parti.localeCompare(b.parti,"da");
      });
      return res;
    }

    /* Parti-combobox */
    function renderPartyCombobox(){
      const stats=getPartyStats(), btn=el("partyButton"), btnc=el("partyButtonContent"), menu=el("partyMenu");
      if(!stats.length){
        btn.disabled=true;
        btnc.innerHTML=`<span class="vb-badge" style="background:#e5e7eb;color:#111827;border-color:#e5e7eb"> </span><span class="truncate text-gray-500">Ingen partier fundet</span>`;
        menu.innerHTML=""; return;
      }
      btn.disabled=false;

      function renderButton(){
        if(!state.activeParty){
          btnc.innerHTML=`<span class="vb-badge" style="background:#e5e7eb;color:#111827;border-color:#e5e7eb"> </span><span class="truncate text-gray-500">Vælg parti…</span>`;
          return;
        }
        const cur=stats.find(s=>s.parti===state.activeParty);
        const {style,text}=badge(cur?.letter||null);
        btnc.innerHTML=`<span class="vb-badge" style="${style}">${text}</span><span class="truncate">${escapeHtml(state.activeParty)}</span>`;
      }
      function renderMenu(){
        menu.innerHTML=stats.map(s=>{
          const {style,text}=badge(s.letter);
          const sel=s.parti===state.activeParty;
          return `<div class="vb-option" role="option" data-parti="${escapeHtml(s.parti)}" aria-selected="${sel}">
                    <span class="vb-badge" style="${style}">${text}</span>
                    <span class="flex-1 truncate">${escapeHtml(s.parti)}</span>
                    <span class="text-xs text-gray-500">${s.kandidatAntal} kandidater</span>
                  </div>`;
        }).join("");
        menu.querySelectorAll('.vb-option').forEach((opt,i)=>{
          opt.onclick=()=>{ state.activeParty=opt.getAttribute('data-parti'); renderButton(); closePartyMenu(); renderPartyDetail(state.activeParty);
            menu.querySelectorAll('.vb-option').forEach((x,j)=>x.setAttribute('aria-selected', j===i)); };
        });
      }

      btn.onclick=()=>{ const open=btn.getAttribute('aria-expanded')==='true'; if(open) closePartyMenu(); else { renderMenu(); openPartyMenu(); } };
      function openPartyMenu(){ btn.setAttribute('aria-expanded','true'); menu.classList.remove('hidden'); menu.focus(); }
      function closePartyMenu(){ btn.setAttribute('aria-expanded','false'); menu.classList.add('hidden'); }
      window.closePartyMenu=closePartyMenu;

      renderButton();
      // vis ikke kandidater automatisk – vent på valg
      el("partyDetailHeader").textContent = "Vælg et parti i drop-down menuen.";
      el("candidateList").innerHTML = "";
    }

    /* Kandidatliste for valgt parti */
    function renderPartyDetail(parti){
      const header=el("partyDetailHeader"), list=el("candidateList"); list.innerHTML="";
      if(!parti){ header.textContent="Vælg et parti i drop-down menuen."; return; }
      header.textContent=parti;
      const kandidaterAll=getPartyStats().find(x=>x.parti===parti)?.kandidater||[];
      const sorted=kandidaterAll.slice().sort(sortKandidaterAlpha);
      for(const k of sorted){
        const row=document.createElement("div");
        row.className="rounded-xl border px-3 py-2 flex items-center justify-between";
        row.innerHTML=`<div><div class="font-medium">${escapeHtml(k.kandidat_navn)}</div>
                       <div class="text-xs text-gray-500">${escapeHtml(k.parti)} · ${fmt(k.total)} stemmer i alt</div></div>
                       <button class="vb-btn" data-add="${k.kandidat_id}">Tilføj</button>`;
        row.querySelector("button[data-add]").onclick=()=>{ state.selected.set(k.kandidat_id,{kandidat_id:k.kandidat_id,kandidat_navn:k.kandidat_navn,parti:k.parti}); renderAll(); };
        list.appendChild(row);
      }
    }

    /* Render alt */
    function renderAll(){
      renderSelected();
      renderPsTable(getPollingStations(), getSelectedOrdered());
      renderChart();
      const hasSel=getSelected().length>0;
      el("compareSection").classList.toggle("hidden",!hasSel);
      el("tabsCard").classList.toggle("hidden",!hasSel);
    }

    /* Valgte kandidater */
    function stemmerLabel(n){ return n===1 ? "stemme" : "stemmer"; }
    function computeTotalsByCandidate(){
      const m=new Map();
      for(const r of state.rows) m.set(r.kandidat_id,(m.get(r.kandidat_id)||0)+r.stemmer);
      return m;
    }
    function renderSelected(){
      const root=el("selectedList"), totals=computeTotalsByCandidate(), sel=getSelectedOrdered();
      function letterForParti(parti){
        const stat = getPartyStats().find(s=>s.parti===parti);
        return stat?.letter || null;
      }
      root.innerHTML= sel.map(k=>{
        const letter=letterForParti(k.parti), bd=badge(letter), total=totals.get(k.kandidat_id)||0;
        return `<div class="rounded-xl border p-3 flex items-center justify-between">
                  <div class="flex items-center gap-3">
                    <span class="vb-badge" style="${bd.style}">${bd.text}</span>
                    <div class="font-medium">${escapeHtml(k.kandidat_navn)} <span class="text-gray-500">(${escapeHtml(k.parti)})</span></div>
                  </div>
                  <div class="flex items-center gap-3">
                    <div class="tabular-nums font-medium">${fmt(total)} personlige ${stemmerLabel(total)} i alt</div>
                    <button class="vb-btn" onclick="removeCandidate('${k.kandidat_id}')">Fjern</button>
                  </div>
                </div>`;
      }).join("") || `<div class="text-sm text-gray-500">Ingen kandidater valgt endnu.</div>`;
      el("btnClearAll").disabled = sel.length===0;
    }
    window.removeCandidate = id => { state.selected.delete(id); renderAll(); };
    const getSelected = () => Array.from(state.selected.values());
    const getSelectedOrdered = () => { const s=getSelected().slice(); s.sort(sortKandidaterAlpha); return s; };

    /* Tabel & diagram */
    function getPollingStations(){
      const m=new Map();
      for(const r of state.rows){
        if(!m.has(r.valgsted_id)) m.set(r.valgsted_id,{id:r.valgsted_id,navn:r.valgsted_navn});
        const ps=m.get(r.valgsted_id);
        ps[r.kandidat_id]=(ps[r.kandidat_id]||0)+r.stemmer;
      }
      return Array.from(m.values()).sort((a,b)=>a.navn.localeCompare(b.navn,"da"));
    }
    function renderPsTable(psList, sel){
      const thead=el("psThead"), tbody=el("psTbody"), tfoot=el("psTFoot");
      if(!sel.length){
        thead.innerHTML=`<tr><th class="text-left py-2 pr-3">Valgsted</th></tr>`;
        tbody.innerHTML=""; tfoot.innerHTML=""; return;
      }
      const header = sel.map(s=>{
        const stat = getPartyStats().find(x=>x.parti===s.parti);
        const bd = badge(stat?.letter || null);
        return `<th class="py-2 pr-3"><div class="flex items-center gap-2">
                  <span class="vb-badge" style="${bd.style};height:24px;width:24px;font-size:.75rem">${bd.text}</span>
                  <span>${escapeHtml(s.kandidat_navn)} (${escapeHtml(s.parti)})</span></div></th>`;
      }).join("");
      thead.innerHTML=`<tr class="text-left border-b"><th class="py-2 pr-3">Valgsted</th>${header}</tr>`;
      tbody.innerHTML=psList.map(ps=>`<tr class="border-b last:border-0">
        <td class="py-2 pr-3 font-medium">${escapeHtml(ps.navn)}</td>
        ${sel.map(s=>`<td class="py-2 pr-3 tabular-nums">${fmt(ps[s.kandidat_id]||0)}</td>`).join("")}
      </tr>`).join("");
      const totals=computeTotalsByCandidate();
      tfoot.innerHTML=`<tr class="border-t"><th class="py-2 pr-3 text-left">Kommunetotal</th>
        ${sel.map(s=>`<td class="py-2 pr-3 tabular-nums font-medium">${fmt(totals.get(s.kandidat_id)||0)}</td>`).join("")}
      </tr>`;
    }

    function renderChart(){
      const canvas=el("chart"), sel=getSelectedOrdered(); if(!sel.length){ resetChart(); return; }
      const ps=getPollingStations(), labels=ps.map(x=>x.navn),
            datasets=sel.map(k=>({label:`${k.kandidat_navn} (${k.parti})`, data:ps.map(x=>x[k.kandidat_id]||0)}));
      if(state.chart) state.chart.destroy();
      state.chart=new Chart(canvas,{ type:"bar", data:{labels,datasets},
        options:{responsive:true,maintainAspectRatio:false,scales:{y:{beginAtZero:true,ticks:{precision:0}}}} });
    }
    function resetChart(){ if(state.chart){ state.chart.destroy(); state.chart=null; } }

    function initTabs(){
      document.querySelectorAll("[data-tab]").forEach(b=>{
        b.onclick=()=>{ document.querySelectorAll(".vb-tabbox").forEach(x=>x.classList.remove("active"));
          b.classList.add("active");
          const t=b.getAttribute("data-tab");
          el("tab-valgsted-tabel").classList.toggle("hidden",t!=="valgsted-tabel");
          el("tab-valgsted-diagram").classList.toggle("hidden",t!=="valgsted-diagram");
        };
      });
    }
    function closePartyMenu(){ const btn=el('partyButton'), menu=el('partyMenu'); btn.setAttribute('aria-expanded','false'); menu.classList.add('hidden'); }
  </script>
</body>
</html>
